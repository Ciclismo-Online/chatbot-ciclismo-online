<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<base target="_top">
<title>Tu Gregario - Ciclismo Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --main-bg:#111426; --chat-bg:#1b1f35; --bot-bubble:#2b2f4a; --user-bubble:#6556f1;
    --highlight:#ffd64d; --text:#e6e6f0; --muted:#a8adc3; --line:#343a60;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--main-bg);color:var(--text);font-family:'Poppins',system-ui,Arial,sans-serif}
  body{display:flex;justify-content:center;align-items:flex-start}
  #main-wrapper{width:100%;max-width:720px;min-height:100vh;background:var(--chat-bg);display:flex;flex-direction:column;box-shadow:0 8px 24px rgba(0,0,0,.45)}
  #chat-header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(180deg,#0f1230,#161a38);border-bottom:1px solid var(--line)}
  #chat-header h1{margin:0;font-size:18px;font-weight:600}
  #chat-container{flex:1;display:flex;flex-direction:column;gap:8px;padding:12px 14px 10px;overflow:auto}
  .message{max-width:82%;padding:10px 14px;border-radius:16px;line-height:1.5}
  .message.bot{align-self:flex-start;background:var(--bot-bubble);border:1px solid #3b3f63}
  .message.user{align-self:flex-end;background:var(--user-bubble);color:#fff;border:1px solid #7f75ff}
  .message strong{color:var(--highlight)}

  /* Cards */
  .cards-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;width:100%;padding-top:6px}
  .product-card{display:flex;flex-direction:column;text-decoration:none;color:var(--text);border:1px solid #3b3f63;background:#262a47;border-radius:12px;transition:.2s ease;overflow:hidden}
  .product-card:hover{transform:translateY(-3px);box-shadow:0 10px 18px rgba(0,0,0,.35)}
  .product-image{height:132px;width:100%;object-fit:cover;background:#202446}
  .product-details{display:flex;flex-direction:column;gap:6px;padding:10px;min-height:112px}
  .product-title{font-size:13px;font-weight:600;line-height:1.35;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
  .product-info-bottom{margin-top:auto;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
  .product-price{font-size:15px;font-weight:700;color:var(--highlight)}

  /* Input */
  #input-container{position:sticky;bottom:0;display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:linear-gradient(180deg,#1a1e37,#161a31)}
  #user-input{flex:1;height:44px;border-radius:24px;background:#23274a;border:1px solid #39406e;color:#fff;padding:0 14px;font-size:15px;outline:none}
  #send-button{width:44px;height:44px;border-radius:50%;background:var(--user-bubble);border:1px solid #7f75ff;color:#fff;display:grid;place-items:center;cursor:pointer}

  /* Chips / filtros (refinado visual) */
  .chips-container{display:flex;flex-direction:column;gap:10px;width:100%;align-self:flex-start;margin-top:8px}
  .chips-hint{color:var(--muted);font-size:13px;margin:0 0 2px 4px}
  .chips-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .chips-group-label{color:#b6bdd6;font-size:12px;min-width:92px;text-align:right;opacity:.9}
  .chip{padding:7px 12px;border-radius:999px;background:#24284a;border:1px solid #3c4474;color:#dfe3ff;font-size:13px;cursor:pointer;user-select:none;transition:.15s}
  .chip:hover{transform:translateY(-1px);background:#2b315a}
  .chip.selected{background:#5a4ef0;border-color:#867fff;color:#fff}
  .chip.plus{border-style:dashed;color:#cbd2ff}

  .apply-filters-btn{background:#5a4ef0;color:#fff;border:none;border-radius:12px;padding:10px 14px;font-size:14px;font-weight:700;box-shadow:0 8px 18px rgba(90,78,240,.35);cursor:pointer}
  .clear-filters-btn{background:transparent;border:1px solid #3b4270;color:#cfd3f5;border-radius:12px;padding:8px 12px;font-size:13px;cursor:pointer}

  /* Skeletons */
  .ge-skeletons{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;width:100%;padding-top:6px}
  .ge-skel{height:260px;border-radius:12px;background:linear-gradient(90deg,#2a2e4c 25%,#3a416d 37%,#2a2e4c 63%);background-size:400% 100%;animation:sh 1.4s infinite}
  @keyframes sh{0%{background-position:100% 0}100%{background-position:-100% 0}}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(680px,94vw);background:#1c2140;border:1px solid #39406e;border-radius:16px;box-shadow:0 24px 44px rgba(0,0,0,.55);padding:14px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .modal-title{font-size:16px;font-weight:700}
  .modal-close{background:transparent;border:1px solid #3d4470;color:#d3d8ff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .modal-content{display:flex;flex-wrap:wrap;gap:8px;max-height:60vh;overflow:auto}

  /* Botonera resultados */
  .results-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#5a4ef0;border:none;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(90,78,240,.35)}
  .btn.secondary{background:transparent;color:#dfe3ff;border:1px solid #3b4270;box-shadow:none}
  .btn:disabled{opacity:.65;cursor:not-allowed}
  .price-highlight{box-shadow:0 0 0 2px #ffd64d inset;animation:blink 1.2s ease 2}
  @keyframes blink{50%{box-shadow:0 0 0 2px transparent inset}}
  @media (max-width:480px){
    .chips-group-label{min-width:84px}
    .product-image{height:120px}
    .message{max-width:92%}
  }
</style>
</head>
<body>

<div id="main-wrapper">
  <div id="chat-header"><h1>Tu Gregario de Ciclismo Online</h1></div>
  <div id="chat-container"></div>

  <div id="input-container">
    <input id="user-input" type="text" placeholder="Preg√∫ntale a Tu Gregario..." autocomplete="off">
    <button id="send-button" aria-label="Enviar">
      <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" fill="none" stroke-width="1.6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.27 3.126A59.77 59.77 0 0121.485 12 59.77 59.77 0 013.27 20.873L6 12zm0 0h7.5"/></svg>
    </button>
  </div>
</div>

<!-- Modal M√°s Categor√≠as -->
<div id="more-cats-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">M√°s categor√≠as</div>
      <button id="modal-close" class="modal-close">Cerrar</button>
    </div>
    <div id="more-cats-content" class="modal-content"></div>
  </div>
</div>

<script>
/* ===================== ESTADO & CONFIG ===================== */
const STATE = Object.freeze({ LANDING:'LANDING', FILTERS:'FILTERS', SEARCHING:'SEARCHING', RESULTS:'RESULTS', FALLBACK:'FALLBACK' });
let currentState = STATE.LANDING;
let currentRequestId = 0;                 // request token (evita respuestas fuera de orden)
let uiLocked = false;

const chat = document.getElementById('chat-container');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-button');

const modalBackdrop = document.getElementById('more-cats-backdrop');
const modalCloseBtn = document.getElementById('modal-close');
const modalContent = document.getElementById('more-cats-content');

let chatHistory = [];
let activeCategory = null;
let activeFilters = {};
let moreFiltersExpanded = {};
let shownProductUrls = new Set();
let lastQueryText = '';

const CONFIG = {
  intents: ['GPS / Ciclocomputadores','Rodillos Inteligentes','Potenci√≥metros','Ruedas','Cascos','Zapatillas','Culottes','Chaquetas','Luces Potentes','Nutrici√≥n','+'],
  CLOUD_FUNCTION_URL: 'https://gregario-chatbot-738677149871.europe-west1.run.app'
};

/* ===================== DATOS DE FACETAS ===================== */
const FACETS_BY_CATEGORY = {
  'Culottes': { Disciplina:['Carretera','MTB','Gravel','Indoor'], Talla:['XS','S','M','L','XL','XXL'], Precio:['<50‚Ç¨','50‚Äì100‚Ç¨','100‚Äì150‚Ç¨','150‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'], Badana:['4‚Äì6h','6‚Äì8h','+8h','Triatl√≥n'], Temporada:['Verano','Invierno','Todo el a√±o'], Material:['Lycra','Compresi√≥n','T√©rmico','Impermeable'] },
  'Cascos': { Disciplina:['Carretera','MTB','Gravel','Enduro','Urbano'], Talla:['S','M','L','XL'], Precio:['<60‚Ç¨','60‚Äì100‚Ç¨','100‚Äì150‚Ç¨','150‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'], Seguridad:['MIPS','SPIN','WaveCel','KinetiCore'], Peso:['<250g','250‚Äì300g','300‚Äì350g','+350g'] },
  'Zapatillas': { Disciplina:['Carretera','MTB','Gravel','Triatl√≥n'], 'Talla EU':['38','39','40','41','42','43','44','45','46','47'], Precio:['<80‚Ç¨','80‚Äì120‚Ç¨','120‚Äì180‚Ç¨','180‚Äì250‚Ç¨','+250‚Ç¨'], Cala:['SPD','SPD-SL','Look KEO'], Rigidez:['Normal','Alta','Carbono'], Ventilaci√≥n:['Alta','Media','Cerrada'] },
  'GPS / Ciclocomputadores': { Navegaci√≥n:['Mapas','Seguimiento b√°sico'], Conectividad:['ANT+/BT','WiFi'], Precio:['<100‚Ç¨','100‚Äì200‚Ç¨','200‚Äì300‚Ç¨','300‚Äì500‚Ç¨','+500‚Ç¨'], M√©tricas:['Potenci√≥metro','Entrenos','Segmentos'] },
  'Rodillos Inteligentes': { Tipo:['Directo','Wheel-on'], Apps:['Zwift','Rouvy','TrainerRoad'], Precio:['<300‚Ç¨','300‚Äì500‚Ç¨','500‚Äì800‚Ç¨','800‚Äì1200‚Ç¨','+1200‚Ç¨'], Potencia:['1000W+','1500W+','2000W+'], Simulaci√≥n:['12%+','16%+','20%+'] },
  'Potenci√≥metros': { Tipo:['Biela','Pedal','Spider','Buje'], Compatibilidad:['Shimano','SRAM','Rotor','Campagnolo'], Precio:['<300‚Ç¨','300‚Äì500‚Ç¨','500‚Äì800‚Ç¨','800‚Äì1200‚Ç¨','+1200‚Ç¨'], Medici√≥n:['1 lado','2 lados'], 'Longitud biela':['165','170','172.5','175'], Precisi√≥n:['¬±1%','¬±2%','¬±3%'] },
  'Ruedas': { Tama√±o:['700C','29"','27.5"'], Freno:['Disco','Zapata'], Precio:['<200‚Ç¨','200‚Äì400‚Ç¨','400‚Äì700‚Ç¨','700‚Äì1200‚Ç¨','+1200‚Ç¨'], Material:['Aluminio','Carbono'], Tubeless:['S√≠','No'] },
  'Luces Potentes': { L√∫menes:['300+','600+','1000+'], Autonom√≠a:['<2h','2‚Äì4h','4h+'], Precio:['<30‚Ç¨','30‚Äì60‚Ç¨','60‚Äì100‚Ç¨','100‚Äì150‚Ç¨','+150‚Ç¨'], Montaje:['Manillar','Casco'] },
  'Chaquetas': { Disciplina:['Carretera','MTB','Gravel','Urbano'], Talla:['XS','S','M','L','XL','XXL'], Precio:['<60‚Ç¨','60‚Äì100‚Ç¨','100‚Äì150‚Ç¨','150‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'], Estaci√≥n:['Invierno','Entretiempo','Lluvia'], Membrana:['>5.000 mm','>10.000 mm','>20.000 mm'] },
  'Nutrici√≥n': { Tipo:['Gel','Barrita','Isot√≥nica','Recuperador'], CarboHora:['30‚Äì60g','60‚Äì90g'], Precio:['<10‚Ç¨','10‚Äì20‚Ç¨','20‚Äì40‚Ç¨','40‚Äì80‚Ç¨','+80‚Ç¨'], Cafe√≠na:['S√≠','No'] }
};
const EXTRA_CATEGORIES = ['Gafas','Guantes','Camisetas interiores','Chubasqueros','Calcetines t√©rmicos','Multiherramientas','Bombas / CO‚ÇÇ','Kits tubeless','Cadenas','Pastillas de freno','Lubricantes','Ceras','Limpiadores','Portabidones','Bidones','Soportes m√≥vil/GPS','Luces traseras','Cintas de manillar','Pu√±os','Sensores HR/Vel/Cad','Sillines'];
const GLOBAL_MIN_FILTERS = { Precio:['<50‚Ç¨','50‚Äì100‚Ç¨','100‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'] };

/* ===================== SIN√ìNIMOS / NORMALIZADOR ===================== */
const SYN = {
  category: {
    'Zapatillas':['zapas','zapatos ciclismo','calas','cycling shoes','shoes'],
    'Cascos':['casco','helmet','yelmo'],
    'Culottes':['culote','culot','culottes','bib short','culottes'],
    'Potenci√≥metros':['potenciometro','potenciometros','power meter','medidor de potencia'],
    'Ruedas':['llantas','rueda','wheelset','aros'],
    'Chaquetas':['chaqueta','cortavientos','jacket'],
    'Luces Potentes':['luz','linterna','frontal','luces']
  },
  discipline: {
    'Carretera':['carretra','road','ruta'],
    'MTB':['btt','mountain','mtv','mt8'],
    'Gravel':['gravl','grabel'],
    'Urbano':['ciudad','commute'],
    'Enduro':['endru']
  }
};
const cap = s => s.charAt(0).toUpperCase() + s.slice(1);

/* ===================== HELPERS UI ===================== */
const log = (...a)=>console.info(...a);
const lockUI = on => {
  uiLocked = on;
  document.querySelectorAll('button,.chip').forEach(el => el.disabled = on);
  sendBtn.disabled = on; input.disabled = on;
};
function appendMsg(role, html){ const d=document.createElement('div'); d.className=`message ${role}`; d.innerHTML=html; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
function clearTransient(){ document.getElementById('chips-container')?.remove(); document.getElementById('results-actions')?.remove(); document.getElementById('loading-skeletons')?.remove(); document.getElementById('loading-inline')?.remove(); }
function showSkeletons(){ const c=document.createElement('div'); c.id='loading-skeletons'; c.className='ge-skeletons'; for(let i=0;i<6;i++){ const s=document.createElement('div'); s.className='ge-skel'; c.appendChild(s);} chat.appendChild(c); chat.scrollTop=chat.scrollHeight; }

/* ===================== LANDING ===================== */
function renderLanding(){
  currentState = STATE.LANDING; clearTransient(); chat.innerHTML='';
  appendMsg('bot', `<strong>Soy Tu Gregario üö¥‚Äç‚ôÇÔ∏è.</strong> Busco gangas ciclistas en las mejores tiendas online por ti. Para mantener este servicio gratuito, utilizo enlaces de afiliado.<br><br><strong>¬øQu√© necesitas hoy?</strong>`);
  const cont=document.createElement('div'); cont.className='chips-container'; cont.id='chips-container';
  const row=document.createElement('div'); row.className='chips-row';
  CONFIG.intents.forEach(lbl=>{
    const c=document.createElement('div'); c.className='chip'+(lbl==='+'?' plus':''); c.textContent=lbl;
    c.onclick = ()=> { if (uiLocked) return; (lbl==='+') ? openMoreCats() : selectCategory(lbl); };
    row.appendChild(c);
  });
  cont.appendChild(row); chat.appendChild(cont);
}

/* ===================== MODAL ===================== */
function openMoreCats(){
  modalContent.innerHTML='';
  EXTRA_CATEGORIES.forEach(cat=>{
    const c=document.createElement('div'); c.className='chip'; c.textContent=cat;
    c.onclick = ()=>{ closeModal(); selectCategory(cat); };
    modalContent.appendChild(c);
  });
  const other=document.createElement('div'); other.className='chip'; other.textContent='Otro producto‚Ä¶';
  other.onclick = ()=>{
    const v=prompt('¬øQu√© producto quieres buscar?');
    if(v && v.trim()!==''){ activeCategory=v.trim(); renderFilters(true); }
    closeModal();
  };
  modalContent.appendChild(other);
  modalBackdrop.style.display='flex';
}
function closeModal(){ modalBackdrop.style.display='none'; }
modalCloseBtn.onclick=closeModal; modalBackdrop.onclick=(e)=>{ if(e.target===modalBackdrop) closeModal(); };

/* ===================== FILTERS ===================== */
function selectCategory(label){
  if (uiLocked) return;
  activeCategory = label; shownProductUrls.clear(); activeFilters={}; moreFiltersExpanded={}; renderFilters();
}
function getGroupsWithPriceFirst(facets){
  const arr=Object.entries(facets); const i=arr.findIndex(([k])=>/precio/i.test(k));
  if(i>0){ const [p]=arr.splice(i,1); arr.splice(2,0,p); } // intentar TOP-3
  return arr;
}
function renderFilters(fallbackIfUnknown=false){
  clearTransient();
  const has = FACETS_BY_CATEGORY[activeCategory];
  currentState = has ? STATE.FILTERS : (fallbackIfUnknown ? STATE.FALLBACK : STATE.FALLBACK);

  const cont=document.createElement('div'); cont.className='chips-container'; cont.id='chips-container';
  const hint=document.createElement('div'); hint.className='chips-hint'; hint.textContent='Ajusta los filtros y te busco las mejores opciones üëá'; cont.appendChild(hint);

  if(currentState===STATE.FALLBACK){
    Object.entries(GLOBAL_MIN_FILTERS).forEach(([g,ch])=>cont.appendChild(createFacetRow(g,ch)));
  }else{
    const groups = getGroupsWithPriceFirst(FACETS_BY_CATEGORY[activeCategory]);
    const first = groups.slice(0,4), rest = groups.slice(4);
    first.forEach(([g,ch])=>cont.appendChild(createFacetRow(g,ch)));
    if(rest.length){
      const more=document.createElement('button'); more.className='apply-filters-btn'; more.textContent='M√°s filtros';
      more.onclick=()=>{ rest.forEach(([g,ch])=>cont.appendChild(createFacetRow(g,ch))); more.remove(); moreFiltersExpanded[activeCategory]=true; chat.scrollTop=chat.scrollHeight; };
      if(moreFiltersExpanded[activeCategory]) rest.forEach(([g,ch])=>cont.appendChild(createFacetRow(g,ch))); else cont.appendChild(more);
    }
  }

  const actions=document.createElement('div'); actions.className='chips-row'; actions.style.justifyContent='space-between';
  const clear=document.createElement('button'); clear.className='clear-filters-btn'; clear.textContent='Limpiar filtros';
  clear.onclick=()=>{ if (uiLocked) return; activeFilters={}; cont.querySelectorAll('.chip.selected').forEach(c=>c.classList.remove('selected')); renderOrRemoveApply(cont); };
  const holder=document.createElement('div'); holder.id='apply-holder';
  actions.appendChild(clear); actions.appendChild(holder); cont.appendChild(actions);

  chat.appendChild(cont); renderOrRemoveApply(cont); log('STATE ->', currentState);
}
function createFacetRow(label, arr){
  const row=document.createElement('div'); row.className='chips-row';
  const l=document.createElement('span'); l.className='chips-group-label'; l.textContent=label; row.appendChild(l);
  arr.forEach(v=>{
    const c=document.createElement('div'); c.className='chip'; c.textContent=v;
    c.onclick=()=>toggleFilterExclusive(row,c,{group:label,value:v});
    row.appendChild(c);
  });
  return row;
}
/* Exclusivo por grupo */
function toggleFilterExclusive(row, chip, data){
  if (uiLocked) return;
  const was = chip.classList.contains('selected');
  row.querySelectorAll('.chip').forEach(el=>el.classList.remove('selected'));
  if (!was) chip.classList.add('selected');
  if (!was) activeFilters[data.group]=data.value; else delete activeFilters[data.group];
  renderOrRemoveApply(document.getElementById('chips-container'));
}
function renderOrRemoveApply(container){
  const h=container.querySelector('#apply-holder'); h.innerHTML='';
  const n=Object.keys(activeFilters).length;
  if(n>0){ const b=document.createElement('button'); b.className='apply-filters-btn'; b.id='apply-btn'; b.textContent=`‚ú® Aplicar filtros y buscar (${n})`; b.onclick=applyFilters; h.appendChild(b); }
}

/* ===================== QUERY BUILDER ===================== */
function buildNaturalQuery(){
  const cat = activeCategory ? activeCategory.toLowerCase() : 'producto';
  const parts = [`Busco ${cat}`];
  for(const [k,v] of Object.entries(activeFilters)){
    const key=k.toLowerCase();
    if(key.includes('disciplina')) parts.push(`para ${v.toLowerCase()}`);
    else if(key.includes('talla eu')) parts.push(`talla EU ${v}`);
    else if(key.includes('talla')) parts.push(`en talla ${v}`);
    else if(key.includes('precio')){
      const vv=v.replace(/\s/g,'');
      if(vv.startsWith('<')) parts.push(`con presupuesto por menos de ${vv.slice(1)}`);
      else if(vv.startsWith('+')) parts.push(`con presupuesto por m√°s de ${vv.slice(1)}`);
      else { const [a,b]=v.split(/‚Äì|-/); parts.push(`con presupuesto entre ${a.trim()} y ${b.trim()} ‚Ç¨`); }
    } else parts.push(`${k} ${v}`);
  }
  parts.push('Devu√©lveme hasta 12 tarjetas con t√≠tulo, imagen, precio y link afiliado. Si no hay stock, sugiere ampliar precio o quitar filtros.');
  return parts.join(', ') + '. Mu√©strame opciones.';
}

/* ===================== BUSCAR / RESULTADOS ===================== */
function resultsActions(){
  document.getElementById('results-actions')?.remove();
  const r=document.createElement('div'); r.className='results-actions'; r.id='results-actions';
  const more=document.createElement('button'); more.className='btn'; more.textContent='M√°s resultados';
  more.onclick=async ()=>{ if (!CAN.more()) return; more.disabled=true; await moreResults(); more.disabled=false; };
  const price=document.createElement('button'); price.className='btn secondary'; price.textContent='Ajustar precio';
  price.onclick=focusPrice;
  const again=document.createElement('button'); again.className='btn secondary'; again.textContent='Nueva b√∫squeda';
  again.onclick=resetLanding;
  r.appendChild(more); r.appendChild(price); r.appendChild(again);
  chat.appendChild(r); chat.scrollTop=chat.scrollHeight;
}
function renderCards(products, append){
  if(!append) shownProductUrls.clear();
  let cont = append ? chat.querySelector('.cards-container') : null;
  if(!append || !cont){ cont=document.createElement('div'); cont.className='cards-container'; chat.appendChild(cont); }
  let added=0;
  (products||[]).forEach(p=>{
    if(!p || !p.url || shownProductUrls.has(p.url)) return;
    shownProductUrls.add(p.url); added++;
    const a=document.createElement('a'); a.className='product-card'; a.href=p.url; a.target='_blank'; a.rel='nofollow sponsored noopener';
    const img=document.createElement('img'); img.className='product-image'; img.src=p.imagen||''; img.alt=p.nombre||'Producto';
    const d=document.createElement('div'); d.className='product-details';
    const t=document.createElement('div'); t.className='product-title'; t.textContent=p.nombre||'';
    const btm=document.createElement('div'); btm.className='product-info-bottom';
    const pr=document.createElement('div'); pr.className='product-price'; pr.textContent=p.precio||'';
    const st=document.createElement('div'); st.textContent=p.tienda ? `eBay ${p.tienda}` : 'eBay';
    btm.appendChild(pr); btm.appendChild(st); d.appendChild(t); d.appendChild(btm); a.appendChild(img); a.appendChild(d); cont.appendChild(a);
  });
  chat.scrollTop=chat.scrollHeight;
  return added;
}

/* Guardas de estado */
const CAN = {
  apply: ()=> currentState===STATE.FILTERS || currentState===STATE.FALLBACK,
  more:  ()=> currentState===STATE.RESULTS,
  free:  ()=> true
};

async function applyFilters(){
  if(!CAN.apply()) return;
  const query = buildNaturalQuery();
  lastQueryText = query;
  await runSearch(query,false);
}
async function moreResults(){
  const query = `${lastQueryText}\nMu√©strame m√°s opciones similares.`;
  await runSearch(query,true);
}

/* Core de b√∫squeda con tokens y loaders */
async function runSearch(query, append){
  const reqId = ++currentRequestId;
  lockUI(true);

  if(!append){
    currentState = STATE.SEARCHING;
    clearTransient(); appendMsg('user', query);
    chatHistory.push({role:'user', content:query});
    showSkeletons();
  }else{
    // loader inline
    chatHistory.push({role:'user', content:query});
    if(!document.getElementById('loading-inline')){
      const l=document.createElement('div'); l.id='loading-inline'; l.innerHTML='<div class="ge-skeletons"><div class="ge-skel"></div><div class="ge-skel"></div><div class="ge-skel"></div></div>'; chat.appendChild(l);
    }
  }

  try{
    const res = await fetch(CONFIG.CLOUD_FUNCTION_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({chatHistory}) });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(reqId !== currentRequestId) return; // respuesta antigua: ignorar

    document.getElementById('loading-skeletons')?.remove();
    document.getElementById('loading-inline')?.remove();

    if(data.success){
      const txt=(data.responseText||'').trim();
      if(txt && !append) appendMsg('bot', txt);
      const added = renderCards(data.products||[], true);
      if(!append) resultsActions(); else resultsActions(); // asegurar CTA siempre
      if(added===0) appendMsg('bot','No hay m√°s resultados por ahora. ¬øAjustamos el precio o probamos otra categor√≠a?');
      currentState = STATE.RESULTS;
    }else{
      appendMsg('bot','Error del servidor: '+data.responseText);
      currentState = FACETS_BY_CATEGORY[activeCategory]?STATE.FILTERS:STATE.FALLBACK;
      renderFilters(currentState===STATE.FALLBACK);
    }
  }catch(e){
    console.error(e);
    document.getElementById('loading-skeletons')?.remove();
    document.getElementById('loading-inline')?.remove();
    appendMsg('bot','Disculpa, ha ocurrido un error de conexi√≥n.');
    // CTA Reintentar
    const row=document.createElement('div'); row.className='results-actions';
    const retry=document.createElement('button'); retry.className='btn'; retry.textContent='Reintentar';
    retry.onclick=()=>runSearch(lastQueryText||buildNaturalQuery(),false);
    row.appendChild(retry); chat.appendChild(row);
    currentState = FACETS_BY_CATEGORY[activeCategory]?STATE.FILTERS:STATE.FALLBACK;
  }finally{
    lockUI(false);
    log('STATE ->', currentState);
  }
}

/* ===================== FOCUS PRECIO / NUEVA B√öSQUEDA ===================== */
function focusPrice(){
  if(currentState!==STATE.FILTERS && currentState!==STATE.FALLBACK){ renderFilters(currentState===STATE.FALLBACK); }
  const cont=document.getElementById('chips-container');
  let lab=[...cont.querySelectorAll('.chips-group-label')].find(el=>/precio/i.test(el.textContent||''));
  if(!lab){
    const more=[...cont.querySelectorAll('button')].find(b=>b.textContent?.toLowerCase().includes('m√°s filtros')); if(more){ more.click(); }
    lab=[...cont.querySelectorAll('.chips-group-label')].find(el=>/precio/i.test(el.textContent||''));
  }
  if(lab){ const row=lab.parentElement; row.classList.add('price-highlight'); row.scrollIntoView({behavior:'smooth',block:'center'}); setTimeout(()=>row.classList.remove('price-highlight'),1500); }
}
function resetLanding(){ activeCategory=null; activeFilters={}; moreFiltersExpanded={}; shownProductUrls.clear(); chat.innerHTML=''; renderLanding(); }

/* ===================== TEXTO LIBRE ‚Üí NORMALIZADOR ===================== */
function normalizeFreeText(msg){
  const m=msg.toLowerCase(); let cat=null, disc=null;
  // categor√≠a conocida directamente
  cat = Object.keys(FACETS_BY_CATEGORY).find(k=>m.includes(k.toLowerCase())) || null;
  if(!cat){
    for(const [canon, list] of Object.entries(SYN.category)){
      if([canon.toLowerCase(),...list.map(x=>x.toLowerCase())].some(w=>m.includes(w))){ cat = canon; break; }
    }
  }
  for(const [canon, list] of Object.entries(SYN.discipline)){
    if([canon.toLowerCase(),...list.map(x=>x.toLowerCase())].some(w=>m.includes(w))){ disc = canon; break; }
  }
  return {cat,disc};
}

/* ===================== ENTRADA LIBRE ===================== */
async function onSend(){
  if(uiLocked) return;
  const msg=input.value.trim(); if(!msg) return;
  appendMsg('user', msg); chatHistory.push({role:'user', content:msg}); input.value='';

  // Si escribe "busco X" lo llevamos a filtros
  if(/^busco\s+/i.test(msg) || true){
    const {cat,disc} = normalizeFreeText(msg);
    if(cat){
      activeCategory = cap(cat); activeFilters={};
      if(disc && FACETS_BY_CATEGORY[activeCategory]?.Disciplina?.includes(cap(disc))){
        activeFilters['Disciplina'] = cap(disc);
      }
      renderFilters(!FACETS_BY_CATEGORY[activeCategory]);
      return;
    }
  }
  appendMsg('bot','Dime qu√© categor√≠a quieres (o pulsa una) y ajustamos filtros para buscarte chollos.');
}

/* ===================== INIT ===================== */
sendBtn.addEventListener('click', onSend);
input.addEventListener('keypress',(e)=>{ if(e.key==='Enter' && !e.shiftKey) onSend(); });
document.addEventListener('DOMContentLoaded', renderLanding);
</script>
</body>
</html>


