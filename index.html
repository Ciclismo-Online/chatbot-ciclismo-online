<!DOCTYPE html>
<html>
<head>
<base target="_top">
<title>Tu Gregario - Ciclismo Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    :root { --main-bg: #1a1a2e; --chat-bg: #24243e; --bot-bubble: #3f3f5f; --user-bubble: #4e44b0; --highlight: #ffcc00; --text-primary: #e0e0e0; --text-secondary: #aaa; --border-color: #33334f; }
    html, body { height: 100%; margin: 0; padding: 0; width: 100%; font-family: 'Poppins', Arial, sans-serif; background-color: var(--main-bg); scroll-behavior: smooth; }
    body { display: flex; justify-content: center; align-items: flex-start; }
    #main-wrapper { width: 100%; max-width: 700px; min-height: 100vh; display: flex; flex-direction: column; background-color: var(--chat-bg); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
    #chat-header { display: flex; align-items: center; padding: 10px 15px; background-color: var(--main-bg); border-bottom: 1px solid var(--border-color); color: white; position: sticky; top: 0; z-index: 10; }
    #chat-header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    #chat-container { flex-grow: 1; padding: 15px; overflow-y: scroll; display: flex; flex-direction: column; gap: 10px; }
    .message { padding: 10px 15px; border-radius: 20px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
    .user { background-color: var(--user-bubble); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
    .bot { background-color: var(--bot-bubble); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 5px; }
    .bot strong { color: var(--highlight); }
    .cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; width: 100%; padding-top: 10px; }
    .product-card { background-color: var(--bot-bubble); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; text-decoration: none; color: var(--text-primary); transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #4a4a6a; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
    .product-image { width: 100%; height: 140px; background-color: #2e2e48; object-fit: cover; }
    .product-details { padding: 10px; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; height: 120px; }
    .product-title { font-size: 14px; font-weight: 600; line-height: 1.3; margin: 0 0 5px 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
    .product-info-bottom { margin-top: auto; }
    .product-price { font-size: 16px; font-weight: 700; color: var(--highlight); }
    .product-store { font-size: 12px; color: var(--text-secondary); }
    #input-container { display: flex; padding: 10px; border-top: 1px solid var(--border-color); background-color: var(--chat-bg); position: sticky; bottom: 0; }
    #user-input { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 25px; background-color: #33334f; color: white; font-size: 16px; margin-right: 10px; outline: none; }
    #send-button { background-color: var(--user-bubble); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s; }
    
    .chips-container { display: flex; flex-direction: column; gap: 12px; align-self: flex-start; width: 100%; margin-top: 12px; }
    .chips-row { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
    .chip { background: rgba(255,255,255,.08); color:#ddd; border:1px solid rgba(255,255,255,.12); padding:8px 14px; border-radius:999px; font-size:.9rem; cursor:pointer; user-select:none; transition: all .2s ease; }
    .chip:hover { transform: translateY(-1px); background: rgba(255,255,255,.12); }
    .chip.selected { background-color: var(--user-bubble); border-color: #8d85f3; color: white; font-weight: 600; }
    .chips-group-label { color:#9aa; font-size:.8rem; margin-right:8px; width: 70px; text-align: right;}
    .apply-filters-btn { background: #5a4ae3; color: #fff; border: none; border-radius: 10px; padding: 10px 16px; font-size: .95rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,.25); width: 100%; margin-top: 10px; font-weight: 600; }
    .apply-filters-btn:hover { filter: brightness(1.1); }
    .ge-skeletons { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px; padding-top:10px; width: 100%;}
    .ge-skel { background: linear-gradient(90deg, var(--bot-bubble) 25%, #4a4a6a 37%, var(--bot-bubble) 63%); background-size: 400% 100%; animation: geShimmer 1.4s infinite; border-radius:12px; height:282px; }
    @keyframes geShimmer { 0% {background-position: 100% 0} 100% {background-position: -100% 0} }
</style>
</head>
<body>

<div id="main-wrapper">
    <div id="chat-header"><h1>Tu Gregario de Ciclismo Online</h1></div>
    <div id="chat-container"></div>
    <div id="input-container">
        <input type="text" id="user-input" placeholder="Pregúntale a Tu Gregario..." autofocus>
        <button id="send-button"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.873L5.999 12zm0 0h7.5" /></svg></button>
    </div>
</div>

<script>
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chatContainer = document.getElementById('chat-container');
    let chatHistory = [];
    let activeFilters = {};
    let baseQuery = ''; 

    const CONFIG = {
        intents: ['GPS / Ciclocomputadores','Rodillos Inteligentes','Potenciómetros','Ruedas','Cascos','Zapatillas','Culottes','Chaquetas','Luces Potentes','Nutrición'],
        refine: {
            disciplina: { label:"Disciplina", chips:["Carretera","MTB","Gravel"] },
            precio:     { label:"Precio",     chips:["< 50€","50–100€","100–200€"] },
            talla: {
                textil:    { label: "Talla", chips: ["S", "M", "L", "XL"] },
                calzado:   { label: "Talla", chips: ["39", "40", "41", "42", "43", "44", "45"] },
                cascos:    { label: "Talla", chips: ["S", "M", "L"] }
            }
        },
        categoryToTallaMap: {'maillot':'textil','culotte':'textil','chaqueta':'textil','guantes':'textil','zapatillas':'calzado','casco':'cascos'},
        categoriasSinTalla: ["luces", "gps", "rodillo", "ruedas", "potenciometro", "nutricion", "otro"],
        CLOUD_FUNCTION_URL: 'https://gregario-chatbot-738677149871.europe-west1.run.app'
    };
    
    async function sendMessage(messageText = null) {
        const message = messageText !== null ? messageText : userInput.value.trim();
        if (message === '') return;

        setLoading(true);
        removeExistingChips();
        appendMessage('user', message);
        chatHistory.push({ role: 'user', content: message });
        if(messageText === null) userInput.value = '';
        
        showLoadingSkeletons();
        
        try {
            const response = await fetch(CONFIG.CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chatHistory: chatHistory })
            });

            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const data = await response.json();
            
            removeLoadingSkeletons();

            if (data.success) {
                const category = extractCategory(data.responseText);
                const cleanResponse = data.responseText.replace(//, '').trim();

                chatHistory.push({ role: 'assistant', content: cleanResponse });
                appendMessage('bot', cleanResponse);
                
                if (data.products && data.products.length > 0) {
                    renderProductCards(data.products);
                } else if (category) {
                    baseQuery = findBaseQuery(message);
                    showRefinementChips(category);
                }
            } else {
                appendMessage('bot', 'Error del servidor: ' + data.responseText);
            }
        } catch (error) {
            console.error('Error de Fetch:', error);
            removeLoadingSkeletons();
            appendMessage('bot', 'Disculpa, ha ocurrido un error de conexión.');
        } finally {
            setLoading(false);
        }
    }

    function findBaseQuery(message) {
        const cleanedMessage = message.toLowerCase();
        const keywords = ['casco','maillot','culotte','chaqueta','guantes','zapatillas','luces','gps','rodillo','ruedas','potenciometro','nutricion'];
        const foundKeyword = keywords.find(kw => cleanedMessage.includes(kw));
        return `Busco ${foundKeyword || 'producto'}`;
    }

    function extractCategory(responseText) {
        const match = responseText.match(//);
        return match ? match[1] : null;
    }

    function appendMessage(sender, message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.innerHTML = message;
        chatContainer.appendChild(messageElement);
        scrollToBottom();
    }
    
    function renderProductCards(products) {
        const container = document.createElement('div');
        container.className = 'cards-container';
        products.forEach(product => {
            const cardLink = document.createElement('a');
            cardLink.href = product.url;
            cardLink.target = '_blank';
            cardLink.rel = 'noopener noreferrer';
            cardLink.className = 'product-card';
            const placeholderImage = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
            cardLink.innerHTML = `
                <img src="${product.imagen || placeholderImage}" class="product-image" alt="${product.nombre}" onerror="this.style.display='none';">
                <div class="product-details">
                    <p class="product-title">${product.nombre}</p>
                    <div class="product-info-bottom">
                        <div class="product-price">${product.precio}</div>
                        <div class="product-store">${product.tienda}</div>
                    </div>
                </div>`;
            container.appendChild(cardLink);
        });
        chatContainer.appendChild(container);
    }
    
    function createChipsRow(chipsData, isMultiSelect, label = null) {
        const row = document.createElement('div');
        row.className = 'chips-row';
        if(label) {
            const labelElement = document.createElement('span');
            labelElement.className = 'chips-group-label';
            labelElement.innerText = label;
            row.appendChild(labelElement);
        }
        chipsData.forEach(chipData => {
            const chipElement = document.createElement('div');
            chipElement.className = 'chip';
            chipElement.innerText = chipData.label;
            if (isMultiSelect) {
                chipElement.onclick = () => handleRefinementClick(chipElement, chipData);
            } else {
                chipElement.onclick = () => sendMessage(chipData.value);
            }
            row.appendChild(chipElement);
        });
        return row;
    }
    
    function showInitialIntentChips() {
        const chips = CONFIG.intents.map(label => ({ label, value: `Busco ${label}` }));
        const chipsElement = createChipsRow(chips, false);
        const container = document.createElement('div');
        container.className = 'chips-container';
        container.id = 'chips-container';
        container.appendChild(chipsElement);
        chatContainer.appendChild(container);
        scrollToBottom();
    }
    
    function showRefinementChips(category) {
        activeFilters = {};
        const container = document.createElement('div');
        container.className = 'chips-container';
        container.id = 'chips-container';
        
        const disciplinaChips = CONFIG.refine.disciplina.chips.map(label => ({ label, value: label, group: 'disciplina' }));
        container.appendChild(createChipsRow(disciplinaChips, true, CONFIG.refine.disciplina.label));

        if (!CONFIG.categoriasSinTalla.includes(category)) {
            const tallaType = CONFIG.categoryToTallaMap[category] || 'textil';
            const tallaConfig = CONFIG.refine.talla[tallaType];
            const tallaChips = tallaConfig.chips.map(label => ({ label, value: label, group: 'talla' }));
            container.appendChild(createChipsRow(tallaChips, true, tallaConfig.label));
        }

        const precioChips = CONFIG.refine.precio.chips.map(label => ({ label, value: label, group: 'precio' }));
        container.appendChild(createChipsRow(precioChips, true, CONFIG.refine.precio.label));
        
        chatContainer.appendChild(container);
        scrollToBottom();
    }

    function handleRefinementClick(chipElement, chipData) {
        const group = chipData.group;
        const previouslySelected = chipElement.classList.contains('selected');
        
        const groupChips = document.querySelectorAll(`.chip[data-group='${group}']`);
        groupChips.forEach(c => c.classList.remove('selected'));

        if (!previouslySelected) {
            chipElement.classList.add('selected');
            chipElement.dataset.group = group;
            activeFilters[group] = chipData.value;
        } else {
            delete activeFilters[group];
        }
        
        let applyBtn = document.getElementById('apply-filters-btn');
        if (Object.keys(activeFilters).length > 0 && !applyBtn) {
            applyBtn = document.createElement('button');
            applyBtn.id = 'apply-filters-btn';
            applyBtn.className = 'apply-filters-btn';
            applyBtn.innerText = '✨ Aplicar Filtros y Buscar';
            applyBtn.onclick = applyFilters;
            document.getElementById('chips-container').appendChild(applyBtn);
        } else if (Object.keys(activeFilters).length === 0 && applyBtn) {
            applyBtn.remove();
        }
    }
    
    function applyFilters() {
        let messageParts = [baseQuery];
        if (activeFilters.disciplina) messageParts.push(`para ${activeFilters.disciplina.toLowerCase()}`);
        if (activeFilters.talla) messageParts.push(`en talla ${activeFilters.talla}`);
        if (activeFilters.precio) messageParts.push(`con un presupuesto de ${activeFilters.precio.replace('€','')}`);
        sendMessage(messageParts.join(' '));
    }
    
    function showLoadingSkeletons() {
        const container = document.createElement('div');
        container.id = 'skeleton-container';
        container.className = 'ge-skeletons';
        for (let i = 0; i < 6; i++) {
            container.innerHTML += `<div class="ge-skel"></div>`;
        }
        chatContainer.appendChild(container);
        scrollToBottom();
    }

    function removeLoadingSkeletons() {
        document.getElementById('skeleton-container')?.remove();
    }

    function removeExistingChips() {
        document.getElementById('chips-container')?.remove();
    }

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function setLoading(isLoading) {
        userInput.disabled = isLoading;
        sendButton.disabled = isLoading;
        if (!isLoading) userInput.focus();
    }

    sendButton.addEventListener('click', () => sendMessage(null));
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(null); });

    document.addEventListener('DOMContentLoaded', () => {
        const welcomeMessage = "<strong>Soy Tu Gregario 🚴‍♂️.</strong> Busco gangas ciclistas en varios eBay por ti.<br><br><strong>¿Qué necesitas hoy?</strong>";
        appendMessage('bot', welcomeMessage);
        showInitialIntentChips();
        userInput.focus();
    });
</script>

</body>
</html>
