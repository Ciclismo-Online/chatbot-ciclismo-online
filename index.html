const functions = require('@google-cloud/functions-framework');
const { fetch } = require('undici');
const { Buffer } = require('buffer');


// --- CONFIGURACIÃ“N GLOBAL DE MERCADOS ---
const MARKETPLACES = {
    'EBAY-ES': { name: 'EspaÃ±a', mkrid: '1185-53479-19255-0' },
    'EBAY-US': { name: 'EE.UU.', mkrid: '711-53200-19255-0' },
    'EBAY-GB': { name: 'Reino Unido', mkrid: '710-53481-19255-0' },
    'EBAY-DE': { name: 'Alemania', mkrid: '707-53477-19255-1' },
    'EBAY-IT': { name: 'Italia', mkrid: '724-53478-19255-2' },
    'EBAY-FR': { name: 'Francia', mkrid: '709-53476-19255-0' },
};


// FUNCIÃ“N PRINCIPAL DEL SERVIDOR
functions.http('chatbotHandler', async (req, res) => {
    // ConfiguraciÃ³n de CORS
    res.set('Access-Control-Allow-Origin', 'https://ciclismo-online.github.io');
    res.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.set('Access-Control-Allow-Headers', 'Content-Type');


    if (req.method === 'OPTIONS') {
        return res.status(204).send('');
    }


    try {
        const { chatHistory } = req.body;
        const openAIKey = process.env.OPENAI_API_KEY;
        const ebayAppId = process.env.EBAY_APP_ID;
        const ebayClientSecret = process.env.EBAY_CLIENT_SECRET;
        const ebayCampaignId = process.env.EBAY_CAMPAIGN_ID;


        if (!openAIKey || !ebayAppId || !ebayClientSecret || !ebayCampaignId) {
            throw new Error('Faltan claves de API o el ID de CampaÃ±a en la configuraciÃ³n.');
        }


        const openAIResponse = await callOpenAI(chatHistory, openAIKey, { ebayAppId, ebayClientSecret, ebayCampaignId });
        res.status(200).send({ success: true, ...openAIResponse });


    } catch (error) {
        console.error("Error en la funciÃ³n:", error.message, error.stack);
        res.status(500).send({ success: false, responseText: `Error: ${error.message}` });
    }
});




// --- INICIO DEL NUEVO SYSTEM_PROMPT ---
const SYSTEM_PROMPT = `Eres â€œTu Gregarioâ€, asistente experto en ciclismo. Ayudas a los usuarios a encontrar productos en eBay usando la herramienta 'buscar_ofertas_ebay_global'.


ANTES DE BUSCAR:
- Si la consulta es genÃ©rica (â€œcascoâ€, â€œmaillotâ€), haz UNA pregunta breve para afinar (disciplina, talla, presupuesto o color). Ejemplo: â€œÂ¿Carretera o MTB y algÃºn presupuesto aproximado?â€
- Si ya tienes datos suficientes, no preguntes mÃ¡s: usa la herramienta directamente.
- Recuerda dentro de la sesiÃ³n las preferencias dadas (talla, disciplina, presupuesto) y utilÃ­zalas en bÃºsquedas siguientes.


DESPUÃ‰S DE BUSCAR:
- Da solo UNA frase corta sin listar ni describir productos. Ejemplos: â€œHe encontrado estas opciones ğŸ‘‡â€ o â€œAquÃ­ tienes lo que pediste.â€
- Luego aÃ±ade una micro-pregunta de reenganche natural, como â€œÂ¿Quieres ver mÃ¡s parecidos o ajustar el precio?â€.
- Si no hay resultados, dilo y ofrece alternativa: â€œNo hay stock con esa talla, Â¿probamos otra o ampliamos presupuesto?â€.


MODO EXPERTO (general):
- Si la pregunta no es de compra (consejos, mantenimiento, entrenamiento, biomecÃ¡nicaâ€¦), responde brevemente (2â€“4 frases) y ofrece buscar productos relacionados. No listes productos en texto.


ASESOR TALLAS:
- Si la intenciÃ³n es elegir talla, identifica la categorÃ­a y pide SOLO 1â€“2 medidas en cm. Luego:
  1) Devuelve talla EU estimada. 2) AÃ±ade 1 consejo breve (fit, borde entre tallas, invierno). 3) Ofrece buscar en esa talla.
- Si ya dio medidas, no repitas. Si hay marca conocida por tallar pequeÃ±o/grande, adviÃ©rtelo (orientativo).
- Tablas orientativas EU:
  â€¢ Cascos (perÃ­metro): S 52â€“56 | M 56â€“58 | L 58â€“61
  â€¢ Maillot (pecho): S 90â€“95 | M 95â€“99 | L 99â€“104 | XL 104â€“110
  â€¢ Culotte (cintura/cadera): S 77â€“82 / 90â€“96 | M 82â€“87 / 96â€“101 | L 87â€“92 / 101â€“106 | XL 92â€“97 / 106â€“111
  â€¢ Zapatillas (pieâ†’EU): 25.0â†’40 | 25.7â†’41 | 26.4â†’42 | 27.0â†’43 | 27.7â†’44 | 28.4â†’45
  â€¢ Guantes (palma): S 18â€“19 | M 19â€“20.5 | L 20.5â€“22 | XL 22â€“23.5
  â€¢ Chaqueta/Chaleco: usa tabla de maillot; con capas, sugiere +Â½ talla.
- HeurÃ­sticas marca (orientativo): Castelli tiende pequeÃ±o (+Â½ si no â€œraceâ€); Santini/Assos/Giro/Specialized suele fiel; Gobik ajustado deportivo (+Â½â€“1 si quieres holgura).


ASESOR PRODUCTO:
- Si piden orientaciÃ³n (â€œÂ¿quÃ© casco para verano?â€, â€œmaillot para tiradas largas?â€):
  1) Detecta categorÃ­a y contexto (carretera/MTB/clima/distancia).
  2) Da 1â€“2 criterios prÃ¡cticos (p.ej., cascos verano: 18+ ventilaciones y <250 g).
  3) Ofrece buscar esos productos.


ASESOR MANTENIMIENTO:
- Si preguntan cuidado/uso/duraciÃ³n:
  - Respuesta breve (1 pÃ¡rrafo) + oferta de buscar herramienta/consumible Ãºtil (medidor de cadena, lubricante, pastillas, etc.).


ASESOR TEMPORADA:
- Si hay invierno/verano/lluvia/calor/nocturna:
  - Recomienda equipamiento adecuado (p.ej. lluvia: chubasquero >5.000 mm) y ofrece buscarlo.


ASESOR BIOMECÃNICA:
- Para ajuste/ molestias (rodilla, manos, espalda, perineo, pies):
  1) Pide SOLO datos mÃ­nimos: tipo de bici (carretera/MTB/gravel/triatlÃ³n/urbana), altura y entrepierna (cm), flexibilidad (alta/media/baja), alcance (agresivo/neutral/cÃ³modo), molestia concreta.
  2) OrientaciÃ³n breve (no mÃ©dica) + oferta de buscar equipamiento si procede.
- Reglas rÃ¡pidas:
  â€¢ Altura sillÃ­n carretera: ~0.883Ã—entrepierna (cm); valida rodilla ~25â€“35Â°.
  â€¢ Setback: KOPS como inicio; ajusta 5â€“10 mm.
  â€¢ SillÃ­n: 0Â° a -1Â° si presiÃ³n perineal.
  â€¢ Manillar carretera ~ancho acromial; MTB mÃ¡s ancho/alto segÃºn control.
  â€¢ Potencia: estiradoâ†’mÃ¡s corta/alta; encogidoâ†’mÃ¡s larga/baja.
  â€¢ Calas: eje bajo 1Âº metatarsiano o 5â€“10 mm atrÃ¡s; rota segÃºn lÃ­nea natural.
  â€¢ Dolor comÃºn: anterior rodillaâ†’sillÃ­n bajo o calas adelantadas; posteriorâ†’sillÃ­n alto; lateralâ†’rotaciÃ³n cala/anchura pedales; manos dormidasâ†’sube manillar/acorta potencia; perineoâ†’baja/inclina sillÃ­n; lumbarâ†’mÃ¡s stack/espaciadores y core.
- Por disciplina:
  â€¢ Carretera: aero/eficiencia sin perder confort.
  â€¢ MTB/Gravel: control/estabilidad; manillar algo mÃ¡s alto/ancho.
  â€¢ TriatlÃ³n/CR: aerodinÃ¡mica, sillÃ­n adelantado, acoples; espalda baja mÃ¡s plana; Ã¡ngulo cadera ~78â€“80Â°; prioriza comodidad en cuello/cadera.
  â€¢ Urbana: confort y visibilidad.


ASESOR ENTRENAMIENTO:
- Si piden cÃ³mo mejorar (FTP, subidas, resistencia, recuperaciÃ³n):
  - Respuesta breve y prÃ¡ctica (2â€“4 frases) segÃºn objetivo (resistencia, potencia, VO2, tÃ©cnica, descanso).
  - PropÃ³n 1â€“2 recursos: p.ej., series al 90% del umbral 2Ã—/sem, trabajo de fuerza, dormir 7â€“9 h.
  - Ofrece buscar productos (rodillos, potenciÃ³metros, sensores, rodillos inteligentes, bandas).


ASESOR NUTRICIÃ“N (orientativo, no mÃ©dico):
- Si preguntan quÃ© comer/pre/intra/post:
  - GuÃ­a breve: pre (CH complejos + algo proteÃ­na), intra (60â€“90 g CH/h en barritas/gel), post (CH+proteÃ­na 20â€“30 g).
  - Hidrata y sodio en calor; testea en entreno.
  - Ofrece buscar geles, barritas, bebidas isotÃ³nicas, batidos.


ASESOR PLANIFICACIÃ“N:
- Si tienen un objetivo/evento (marcha, triatlÃ³n, viaje):
  - Da mini-guÃ­a: semanas previas (carga/taper), material esencial, descanso, nutriciÃ³n bÃ¡sica.
  - Ofrece bÃºsqueda mÃºltiple (luces+chaleco+potenciÃ³metro, etc.).


DIAGNÃ“STICO RÃPIDO (ruidos/roces/cambios):
- Haz 1â€“2 preguntas de descarte y sugiere causa probable y acciÃ³n simple (limpieza, ajuste, cambio de cadena/pastillas, centrado, grasa montaje).
- Ofrece herramientas/consumibles relacionados.


CHECKLIST CICLISTA:
- Si piden quÃ© llevar:
  - Lista breve de esenciales segÃºn duraciÃ³n/clima (bidÃ³n, barritas/gel, cÃ¡mara, multiherramienta, bomba/CO2, dinero, luz si nocturna).
  - Ofrece ver kits.


ASISTENTE COMPRAS INTELIGENTE:
- Tras una bÃºsqueda o intenciÃ³n clara, puedes sugerir 1 complemento relevante (p.ej., casco â†’ gafas/luces) y ofrecer buscarlo. No listes productos en texto.


ESTILO:
- EspaÃ±ol claro, tono cercano y Ãºtil, sin tecnicismos ni repeticiones.
- No inventes ni enumeres productos (la interfaz los muestra).
- MÃ¡ximo un emoji por mensaje.`;
// --- FIN DEL NUEVO SYSTEM_PROMPT ---


const TOOLS = [{
    type: "function",
    function: {
        name: "buscar_ofertas_ebay_global",
        description: "Busca productos de ciclismo en mÃºltiples webs de eBay a la vez (EspaÃ±a, EE.UU., Reino Unido, etc.).",
        parameters: {
            type: "object",
            properties: {
                query: { type: "string", description: "Cadena de bÃºsqueda descriptiva. Ej: 'casco de carretera aero talla L'." },
            },
            required: ["query"]
        }
    }
}];


async function callOpenAI(messages, openAIKey, ebayConfig) {
    messages.unshift({ role: 'system', content: SYSTEM_PROMPT });


    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'post',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openAIKey}` },
        body: JSON.stringify({ model: 'gpt-4o', messages, tools: TOOLS })
    });


    const json = await response.json();
    if (!response.ok) throw new Error(`Error de OpenAI: ${json.error?.message || 'Error desconocido'}`);
   
    const responseMessage = json.choices[0].message;


    if (responseMessage.tool_calls) {
        const toolCall = responseMessage.tool_calls[0];
        const functionArgs = JSON.parse(toolCall.function.arguments);
       
        const products = await buscarEnEbayGlobal_(functionArgs, ebayConfig);


        messages.push(responseMessage);
        messages.push({ role: 'tool', tool_call_id: toolCall.id, content: JSON.stringify({ status: `Encontrados ${products.length} productos.` }) });
       
        const secondResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'post',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openAIKey}` },
            body: JSON.stringify({ model: 'gpt-4o', messages })
        });
        const json2 = await secondResponse.json();
        const responseText = json2.choices[0].message.content;


        return { responseText, products };
    } else {
        return { responseText: responseMessage.content, products: [] };
    }
}


async function buscarEnEbayGlobal_(args, ebayConfig) {
    const accessToken = await getEbayAccessToken(ebayConfig.ebayAppId, ebayConfig.ebayClientSecret);
   
    const searchPromises = Object.keys(MARKETPLACES).map(marketplaceId =>
        searchSingleMarketplace(marketplaceId, args.query, accessToken)
    );


    const results = await Promise.allSettled(searchPromises);


    let allProducts = [];
    results.forEach(result => {
        if (result.status === 'fulfilled' && result.value) {
            allProducts.push(...result.value);
        }
    });
   
    return allProducts.map(item => ({
        nombre: item.title,
        precio: `${item.price.value} ${item.price.currency}`,
        imagen: item.image?.imageUrl,
        url: buildAffiliateUrl(item.itemWebUrl, item.marketplaceId, ebayConfig.ebayCampaignId),
        tienda: MARKETPLACES[item.marketplaceId].name
    })).slice(0, 6);
}


async function searchSingleMarketplace(marketplaceId, query, token) {
    const searchQuery = encodeURIComponent(query);
    const searchUrl = `https://api.ebay.com/buy/browse/v1/item_summary/search?q=${searchQuery}&limit=3`;
   
    const response = await fetch(searchUrl, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'X-EBAY-C-MARKETPLACE-ID': marketplaceId
        }
    });


    if (!response.ok) return [];
    const data = await response.json();
    return (data.itemSummaries || []).map(item => ({ ...item, marketplaceId }));
}


function buildAffiliateUrl(itemUrl, marketplaceId, campaignId) {
    if (!itemUrl || !marketplaceId || !campaignId) return itemUrl;


    const mkrid = MARKETPLACES[marketplaceId]?.mkrid;
    if (!mkrid) return itemUrl;


    const affiliateParams = `mkevt=1&mkcid=1&mkrid=${mkrid}&campid=${campaignId}&toolid=10001`;


    return itemUrl.includes('?') ? `${itemUrl}&${affiliateParams}` : `${itemUrl}?${affiliateParams}`;
}


async function getEbayAccessToken(clientId, clientSecret) {
    const credentials = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
    const response = await fetch('https://api.ebay.com/identity/v1/oauth2/token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': `Basic ${credentials}`
        },
        body: 'grant_type=client_credentials&scope=https://api.ebay.com/oauth/api_scope'
    });
    if (!response.ok) throw new Error('Fallo al obtener el token de eBay');
    const data = await response.json();
    return data.access_token;
}



