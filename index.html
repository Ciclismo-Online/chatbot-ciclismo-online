<!DOCTYPE html>
<html>
<head>
<base target="_top">
<title>Tu Gregario - Ciclismo Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--main-bg:#1a1a2e;--chat-bg:#24243e;--bot-bubble:#3f3f5f;--user-bubble:#4e44b0;--highlight:#ffcc00;--text-primary:#e0e0e0;--text-secondary:#aaa;--border-color:#33334f;}
  html,body{height:100%;margin:0;padding:0;width:100%;font-family:'Poppins',Arial,sans-serif;background-color:var(--main-bg);}
  body{display:flex;justify-content:center;align-items:flex-start;}
  #main-wrapper{width:100%;max-width:700px;min-height:100vh;display:flex;flex-direction:column;background-color:var(--chat-bg);box-shadow:0 4px 12px rgba(0,0,0,.5);}
  #chat-header{display:flex;align-items:center;padding:10px 15px;background-color:var(--main-bg);border-bottom:1px solid var(--border-color);color:white;position:sticky;top:0;z-index:10;}
  #chat-header h1{font-size:18px;font-weight:600;margin:0;}
  #chat-container{flex-grow:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;}
  .message{padding:10px 15px;border-radius:20px;max-width:80%;word-wrap:break-word;line-height:1.5;}
  .user{background-color:var(--user-bubble);color:white;align-self:flex-end;border-bottom-right-radius:5px;}
  .bot{background-color:var(--bot-bubble);color:var(--text-primary);align-self:flex-start;border-bottom-left-radius:5px;}
  .bot strong{color:var(--highlight);}

  .cards-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;width:100%;padding-top:10px;}
  .product-card{background-color:var(--bot-bubble);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;text-decoration:none;color:var(--text-primary);transition:transform .2s,box-shadow .2s;border:1px solid #4a4a6a;}
  .product-card:hover{transform:translateY(-5px);box-shadow:0 6px 15px rgba(0,0,0,.4);}
  .product-image{width:100%;height:140px;background-color:#2e2e48;object-fit:cover;}
  .product-details{padding:10px;display:flex;flex-direction:column;flex-grow:1;justify-content:space-between;height:120px;}
  .product-title{font-size:14px;font-weight:600;line-height:1.3;margin:0 0 5px 0;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;}
  .product-info-bottom{margin-top:auto;}
  .product-price{font-size:16px;font-weight:700;color:var(--highlight);}
  .product-store{font-size:12px;color:var(--text-secondary);}

  #input-container{display:flex;padding:10px;border-top:1px solid var(--border-color);background-color:var(--chat-bg);position:sticky;bottom:0;}
  #user-input{flex-grow:1;padding:10px 15px;border:none;border-radius:25px;background-color:#33334f;color:white;font-size:16px;margin-right:10px;outline:none;}
  #send-button{background-color:var(--user-bubble);color:white;border:none;border-radius:50%;width:45px;height:45px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background-color .3s;}

  /* Chips / filtros */
  .chips-container{display:flex;flex-direction:column;gap:12px;align-self:flex-start;width:100%;margin-top:12px;}
  .chips-hint{color:#9aa;font-size:.85rem;margin:2px 0 4px 4px;}
  .chips-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;}
  .chip{background:rgba(255,255,255,.08);color:#ddd;border:1px solid rgba(255,255,255,.12);padding:8px 14px;border-radius:999px;font-size:.9rem;cursor:pointer;user-select:none;transition:all .2s ease;}
  .chip:hover{transform:translateY(-1px);background:rgba(255,255,255,.12);}
  .chip.selected{background-color:var(--user-bubble);border-color:#8d85f3;color:white;}
  .chip.plus{border-style:dashed;}
  .chips-group-label{color:#9aa;font-size:.8rem;margin-right:8px;width:90px;text-align:right;}
  .apply-filters-btn{background:#5a4ae3;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-size:.95rem;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25);font-weight:600;}
  .clear-filters-btn{background:transparent;color:#bbb;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:8px 12px;font-size:.85rem;cursor:pointer;}

  /* Skeletons */
  .ge-skeletons{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;padding-top:10px;width:100%;}
  .ge-skel{background:linear-gradient(90deg,var(--bot-bubble) 25%,#4a4a6a 37%,var(--bot-bubble) 63%);background-size:400% 100%;animation:geShimmer 1.4s infinite;border-radius:12px;height:282px;}
  @keyframes geShimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

  /* Modal ‚ÄúM√°s categor√≠as‚Äù */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50;}
  .modal{background:var(--chat-bg);border:1px solid var(--border-color);border-radius:16px;padding:16px;max-width:640px;width:calc(100% - 32px);box-shadow:0 10px 30px rgba(0,0,0,.45);}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
  .modal-title{color:#fff;font-size:16px;font-weight:600;}
  .modal-close{background:transparent;color:#ddd;border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:8px;cursor:pointer;}
  .modal-content{display:flex;flex-wrap:wrap;gap:.5rem;max-height:60vh;overflow:auto;}

  /* Botonera de resultados */
  .results-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:10px;}
  .results-actions .btn{background:#5a4ae3;border:none;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25);}
  .results-actions .btn.secondary{background:transparent;color:#ddd;border:1px solid rgba(255,255,255,.2);}
  .price-highlight{box-shadow:0 0 0 2px #ffd54f inset;animation:blink 1.2s ease 2;}
  @keyframes blink{50%{box-shadow:0 0 0 2px transparent inset}}
</style>
</head>
<body>

<div id="main-wrapper">
  <div id="chat-header"><h1>Tu Gregario de Ciclismo Online</h1></div>
  <div id="chat-container"></div>
  <div id="input-container">
    <input type="text" id="user-input" placeholder="Preg√∫ntale a Tu Gregario..." autofocus>
    <button id="send-button"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.873L5.999 12zm0 0h7.5"/></svg></button>
  </div>
</div>

<!-- Modal M√°s Categor√≠as -->
<div id="more-cats-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">M√°s categor√≠as</div>
      <button id="modal-close" class="modal-close">Cerrar</button>
    </div>
    <div id="more-cats-content" class="modal-content"></div>
  </div>
</div>

<script>
  // ======= Estado global (m√°quina simple) =======
  const STATE = Object.freeze({ LANDING:'LANDING', FILTERS:'FILTERS', SEARCHING:'SEARCHING', RESULTS:'RESULTS', FALLBACK:'FALLBACK' });
  let currentState = STATE.LANDING;

  const chatContainer = document.getElementById('chat-container');
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');

  const modalBackdrop = document.getElementById('more-cats-backdrop');
  const modalCloseBtn = document.getElementById('modal-close');
  const modalContent = document.getElementById('more-cats-content');

  // Conversaci√≥n y b√∫squeda
  let chatHistory = [];
  let activeCategory = null;
  let activeFilters = {};
  let moreFiltersExpanded = {};
  let shownProductUrls = new Set();
  let lastQueryText = ''; // √∫ltima consulta enviada al backend, para "M√°s resultados"

  const CONFIG = {
    intents: [
      'GPS / Ciclocomputadores','Rodillos Inteligentes','Potenci√≥metros','Ruedas',
      'Cascos','Zapatillas','Culottes','Chaquetas','Luces Potentes','Nutrici√≥n','+'
    ],
    CLOUD_FUNCTION_URL: 'https://gregario-chatbot-738677149871.europe-west1.run.app'
  };

  // Facetas (Precio priorizada visualmente)
  const FACETS_BY_CATEGORY = {
    'Culottes': {
      Disciplina:['Carretera','MTB','Gravel','Indoor'],
      Talla:['XS','S','M','L','XL','XXL'],
      Precio:['<50‚Ç¨','50‚Äì100‚Ç¨','100‚Äì150‚Ç¨','150‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'],
      Badana:['4‚Äì6h','6‚Äì8h','+8h','Triatl√≥n'],
      Temporada:['Verano','Invierno','Todo el a√±o'],
      Material:['Lycra','Compresi√≥n','T√©rmico','Impermeable']
    },
    'Cascos': {
      Disciplina:['Carretera','MTB','Gravel','Enduro','Urbano'],
      Talla:['S','M','L','XL'],
      Precio:['<60‚Ç¨','60‚Äì100‚Ç¨','100‚Äì150‚Ç¨','150‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'],
      Seguridad:['MIPS','SPIN','WaveCel','KinetiCore'],
      Peso:['<250g','250‚Äì300g','300‚Äì350g','+350g']
    },
    'Zapatillas': {
      Disciplina:['Carretera','MTB','Gravel','Triatl√≥n'],
      'Talla EU':['38','39','40','41','42','43','44','45','46','47'],
      Precio:['<80‚Ç¨','80‚Äì120‚Ç¨','120‚Äì180‚Ç¨','180‚Äì250‚Ç¨','+250‚Ç¨'],
      Cala:['SPD','SPD-SL','Look KEO'],
      Rigidez:['Normal','Alta','Carbono'],
      Ventilaci√≥n:['Alta','Media','Cerrada']
    },
    'GPS / Ciclocomputadores': {
      Navegaci√≥n:['Mapas','Seguimiento b√°sico'],
      Conectividad:['ANT+/BT','WiFi'],
      Precio:['<100‚Ç¨','100‚Äì200‚Ç¨','200‚Äì300‚Ç¨','300‚Äì500‚Ç¨','+500‚Ç¨'],
      M√©tricas:['Potenci√≥metro','Entrenos','Segmentos']
    },
    'Rodillos Inteligentes': {
      Tipo:['Directo','Wheel-on'],
      Apps:['Zwift','Rouvy','TrainerRoad'],
      Precio:['<300‚Ç¨','300‚Äì500‚Ç¨','500‚Äì800‚Ç¨','800‚Äì1200‚Ç¨','+1200‚Ç¨'],
      Potencia:['1000W+','1500W+','2000W+'],
      Simulaci√≥n:['12%+','16%+','20%+']
    },
    'Potenci√≥metros': {
      Tipo:['Biela','Pedal','Spider','Buje'],
      Compatibilidad:['Shimano','SRAM','Rotor','Campagnolo'],
      Precio:['<300‚Ç¨','300‚Äì500‚Ç¨','500‚Äì800‚Ç¨','800‚Äì1200‚Ç¨','+1200‚Ç¨'],
      Medici√≥n:['1 lado','2 lados'],
      'Longitud biela':['165','170','172.5','175'],
      Precisi√≥n:['¬±1%','¬±2%','¬±3%']
    },
    'Ruedas': {
      Tama√±o:['700C','29"','27.5"'],
      Freno:['Disco','Zapata'],
      Precio:['<200‚Ç¨','200‚Äì400‚Ç¨','400‚Äì700‚Ç¨','700‚Äì1200‚Ç¨','+1200‚Ç¨'],
      Material:['Aluminio','Carbono'],
      Tubeless:['S√≠','No']
    },
    'Luces Potentes': {
      L√∫menes:['300+','600+','1000+'],
      Autonom√≠a:['<2h','2‚Äì4h','4h+'],
      Precio:['<30‚Ç¨','30‚Äì60‚Ç¨','60‚Äì100‚Ç¨','100‚Äì150‚Ç¨','+150‚Ç¨'],
      Montaje:['Manillar','Casco']
    },
    'Chaquetas': {
      Disciplina:['Carretera','MTB','Gravel','Urbano'],
      Talla:['XS','S','M','L','XL','XXL'],
      Precio:['<60‚Ç¨','60‚Äì100‚Ç¨','100‚Äì150‚Ç¨','150‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'],
      Estaci√≥n:['Invierno','Entretiempo','Lluvia'],
      Membrana:['>5.000 mm','>10.000 mm','>20.000 mm']
    },
    'Nutrici√≥n': {
      Tipo:['Gel','Barrita','Isot√≥nica','Recuperador'],
      CarboHora:['30‚Äì60g','60‚Äì90g'],
      Precio:['<10‚Ç¨','10‚Äì20‚Ç¨','20‚Äì40‚Ç¨','40‚Äì80‚Ç¨','+80‚Ç¨'],
      Cafe√≠na:['S√≠','No']
    }
  };

  const EXTRA_CATEGORIES = [
    'Gafas','Guantes','Camisetas interiores','Chubasqueros','Calcetines t√©rmicos',
    'Multiherramientas','Bombas / CO‚ÇÇ','Kits tubeless','Cadenas','Pastillas de freno',
    'Lubricantes','Ceras','Limpiadores','Portabidones','Bidones',
    'Soportes m√≥vil/GPS','Luces traseras','Cintas de manillar','Pu√±os',
    'Sensores HR/Vel/Cad','Sillines','Cinta tubular'
  ];

  const GLOBAL_MIN_FILTERS = { Precio:['<50‚Ç¨','50‚Äì100‚Ç¨','100‚Äì200‚Ç¨','200‚Äì300‚Ç¨','+300‚Ç¨'] };

  const log = (...args)=>console.info(...args); // trazas m√≠nimas

  // ======= Render helpers =======
  function appendMessage(sender, html){
    const el=document.createElement('div');
    el.classList.add('message',sender);
    el.innerHTML=html;
    chatContainer.appendChild(el);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
  function clearTransientUI(){
    document.getElementById('chips-container')?.remove();
    document.getElementById('results-actions')?.remove();
    document.getElementById('loading-skeletons')?.remove();
  }
  function showSkeletons(){
    const c=document.createElement('div'); c.className='ge-skeletons'; c.id='loading-skeletons';
    for(let i=0;i<6;i++){ const sk=document.createElement('div'); sk.className='ge-skel'; c.appendChild(sk); }
    chatContainer.appendChild(c);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
  function setLoading(b){ sendButton.disabled=b; userInput.disabled=b; }

  // ======= Landing =======
  function renderLanding(){
    currentState = STATE.LANDING;
    clearTransientUI();
    appendMessage('bot', "<strong>Soy Tu Gregario üö¥‚Äç‚ôÇÔ∏è.</strong> Busco gangas ciclistas en varios eBay por ti.<br><br><strong>¬øQu√© necesitas hoy?</strong>");
    const container=document.createElement('div'); container.className='chips-container'; container.id='chips-container';
    const row=document.createElement('div'); row.className='chips-row';
    CONFIG.intents.forEach(label=>{
      const chip=document.createElement('div'); chip.className='chip'+(label==='+'?' plus':''); chip.innerText=label;
      chip.onclick = label==='+' ? openMoreCategories : ()=>selectCategory(label);
      row.appendChild(chip);
    });
    container.appendChild(row);
    chatContainer.appendChild(container);
  }

  function openMoreCategories(){
    modalContent.innerHTML='';
    EXTRA_CATEGORIES.forEach(cat=>{
      const chip=document.createElement('div'); chip.className='chip'; chip.innerText=cat;
      chip.onclick=()=>{ closeModal(); selectCategory(cat); };
      modalContent.appendChild(chip);
    });
    const other=document.createElement('div'); other.className='chip'; other.innerText='Otro producto‚Ä¶';
    other.onclick=()=>{
      const val=prompt('¬øQu√© producto quieres buscar?');
      if(val && val.trim()!==''){ activeCategory = val.trim(); renderFilters(true); }
      closeModal();
    };
    modalContent.appendChild(other);
    modalBackdrop.style.display='flex';
  }
  function closeModal(){ modalBackdrop.style.display='none'; }
  modalCloseBtn.onclick=closeModal;
  modalBackdrop.onclick=(e)=>{ if(e.target===modalBackdrop) closeModal(); };

  // ======= Filters =======
  function selectCategory(label){
    activeCategory = label;
    shownProductUrls.clear();
    activeFilters = {};
    moreFiltersExpanded = {};
    renderFilters();
  }

  function getFacetGroupsWithPriceFirst(facets){
    const entries = Object.entries(facets);
    const priceIdx = entries.findIndex(([k])=>/precio/i.test(k));
    if(priceIdx>0){ const [pair]=entries.splice(priceIdx,1); entries.splice(2,0,pair); } // intenta TOP3
    return entries;
  }

  function renderFilters(fallbackIfUnknown=false){
    clearTransientUI();
    const hasFacets = FACETS_BY_CATEGORY[activeCategory];
    if(!hasFacets && !fallbackIfUnknown){
      // categor√≠a externa desconocida -> fallback m√≠nimo
      currentState = STATE.FALLBACK;
    }else{
      currentState = STATE.FILTERS;
    }

    const container=document.createElement('div'); container.className='chips-container'; container.id='chips-container';
    const hint=document.createElement('div'); hint.className='chips-hint'; hint.textContent='Ajusta los filtros y te busco las mejores opciones üëá';
    container.appendChild(hint);

    if(currentState===STATE.FALLBACK){
      Object.entries(GLOBAL_MIN_FILTERS).forEach(([group,chips])=>container.appendChild(createFacetRow(group, chips)));
    }else{
      const facets = FACETS_BY_CATEGORY[activeCategory];
      const groups = getFacetGroupsWithPriceFirst(facets);
      const FIRST = 4;
      const first = groups.slice(0,FIRST);
      const rest  = groups.slice(FIRST);

      first.forEach(([group,chips])=>container.appendChild(createFacetRow(group, chips)));

      if(rest.length){
        const moreBtn=document.createElement('button'); moreBtn.className='apply-filters-btn'; moreBtn.innerText='M√°s filtros';
        moreBtn.onclick=()=>{ rest.forEach(([g,ch])=>container.appendChild(createFacetRow(g,ch))); moreBtn.remove(); moreFiltersExpanded[activeCategory]=true; chatContainer.scrollTop=chatContainer.scrollHeight; };
        if(moreFiltersExpanded[activeCategory]) rest.forEach(([g,ch])=>container.appendChild(createFacetRow(g,ch))); else container.appendChild(moreBtn);
      }
    }

    // Barra acciones
    const actions=document.createElement('div'); actions.className='chips-row'; actions.style.justifyContent='space-between'; actions.style.alignItems='center';
    const clearBtn=document.createElement('button'); clearBtn.className='clear-filters-btn'; clearBtn.innerText='Limpiar filtros';
    clearBtn.onclick=()=>{ activeFilters={}; container.querySelectorAll('.chip.selected').forEach(c=>c.classList.remove('selected')); renderOrRemoveApplyBtn(container); };

    const holder=document.createElement('div'); holder.id='apply-holder';
    actions.appendChild(clearBtn); actions.appendChild(holder); container.appendChild(actions);

    chatContainer.appendChild(container);
    renderOrRemoveApplyBtn(container);
    log('STATE ->', currentState);
  }

  function createFacetRow(label, chipsArr){
    const row=document.createElement('div'); row.className='chips-row';
    const labelEl=document.createElement('span'); labelEl.className='chips-group-label'; labelEl.innerText=label;
    row.appendChild(labelEl);
    chipsArr.forEach(lbl=>{
      const chip=document.createElement('div'); chip.className='chip'; chip.innerText=lbl;
      chip.onclick=()=>toggleFilter(chip,{group:label, value:lbl});
      row.appendChild(chip);
    });
    return row;
  }
  function toggleFilter(chipEl, chipData){
    chipEl.classList.toggle('selected');
    if(chipEl.classList.contains('selected')) activeFilters[chipData.group]=chipData.value;
    else delete activeFilters[chipData.group];
    renderOrRemoveApplyBtn(document.getElementById('chips-container'));
  }
  function renderOrRemoveApplyBtn(container){
    const holder=container.querySelector('#apply-holder');
    holder.innerHTML='';
    const count=Object.keys(activeFilters).length;
    if(count>0){
      const btn=document.createElement('button'); btn.className='apply-filters-btn'; btn.id='apply-filters-btn';
      btn.innerText=`‚ú® Aplicar filtros y buscar (${count})`;
      btn.onclick=applyFilters;
      holder.appendChild(btn);
    }
  }

  // ======= Query builder (plantilla fija) =======
  function buildNaturalQuery(){
    const cat = activeCategory ? activeCategory.toLowerCase() : 'producto';
    const parts = [`Busco ${cat}`];

    for(const [k,v] of Object.entries(activeFilters)){
      const key=k.toLowerCase();
      if(key.includes('disciplina')) parts.push(`para ${v.toLowerCase()}`);
      else if(key.includes('talla') && !key.includes('eu')) parts.push(`en talla ${v}`);
      else if(key.includes('talla eu')) parts.push(`talla EU ${v}`);
      else if(key.includes('precio')){
        if(v.startsWith('<')) parts.push(`con presupuesto por menos de ${v.replace('<','')}`);
        else if(v.startsWith('+')) parts.push(`con presupuesto por m√°s de ${v.replace('+','')}`);
        else if(/‚Äì|-/.test(v)){ const [a,b]=v.replace('‚Ç¨','').split(/‚Äì|-/); parts.push(`con presupuesto entre ${a.trim()} y ${b.trim()} ‚Ç¨`); }
        else parts.push(`con presupuesto ${v}`);
      }
      else if(key==='seguridad') parts.push(`con ${v}`);
      else if(key==='peso') parts.push(`peso ${v}`);
      else if(key==='cala') parts.push(`para calas ${v}`);
      else if(key==='rigidez') parts.push(`rigidez ${v.toLowerCase()}`);
      else if(key==='ventilaci√≥n' || key==='ventilacion') parts.push(`ventilaci√≥n ${v.toLowerCase()}`);
      else if(key==='navegaci√≥n' || key==='navegacion') parts.push(v==='Mapas'?'con mapas':'para seguimiento b√°sico');
      else if(key==='conectividad') parts.push(`conectividad ${v}`);
      else if(key==='m√©tricas' || key==='metricas') parts.push(`m√©tricas ${v.toLowerCase()}`);
      else if(key==='tipo') parts.push(`de tipo ${v.toLowerCase()}`);
      else if(key==='apps') parts.push(`compatible con ${v}`);
      else if(key==='potencia' || key==='simulaci√≥n' || key==='simulacion') parts.push(`${key} ${v}`);
      else if(key==='compatibilidad') parts.push(`compatibles con ${v}`);
      else if(key==='medici√≥n' || key==='medicion') parts.push(`medici√≥n ${v}`);
      else if(key==='longitud biela') parts.push(`biela ${v} mm`);
      else if(key==='precisi√≥n' || key==='precision') parts.push(`precisi√≥n ${v}`);
      else if(key==='tama√±o' || key==='tamano') parts.push(`${v}`);
      else if(key==='freno') parts.push(`freno de ${v.toLowerCase()}`);
      else if(key==='material') parts.push(v.toLowerCase());
      else if(key==='tubeless') parts.push(`tubeless ${v.toLowerCase()}`);
      else if(key==='l√∫menes' || key==='lumenes') parts.push(`${v} l√∫menes`);
      else if(key==='autonom√≠a' || key==='autonomia') parts.push(`autonom√≠a ${v}`);
      else if(key==='montaje') parts.push(`montaje en ${v.toLowerCase()}`);
      else if(key==='estaci√≥n' || key==='estacion') parts.push(`de ${v.toLowerCase()}`);
      else if(key==='membrana') parts.push(`membrana ${v}`);
      else if(key==='carbohora') parts.push(`${v} de carbo/h`);
      else if(key==='cafe√≠na' || key==='cafeina') parts.push(`con cafe√≠na`);
      else if(key==='badana') parts.push(`badana ${v}`);
    }

    parts.push('Devu√©lveme hasta 12 tarjetas con t√≠tulo, imagen, precio y link afiliado. Si no hay stock, sugiere ampliar precio o quitar filtros.');
    parts.push('Mu√©strame opciones.');
    return parts.join(', ').replace(', Mu√©strame opciones.','. Mu√©strame opciones.');
  }

  // ======= Buscar (solo desde FILTERS/RESULTS) =======
  async function applyFilters(){
    if(!(currentState===STATE.FILTERS || currentState===STATE.FALLBACK)) return;
    const query = buildNaturalQuery();
    lastQueryText = query;
    await runSearch(query, /*appendResults*/ false);
  }

  async function moreResults(){
    if(currentState!==STATE.RESULTS) return;
    const query = `${lastQueryText}\nMu√©strame m√°s opciones similares.`;
    await runSearch(query, /*appendResults*/ true);
  }

  async function runSearch(query, append){
    // Transici√≥n a SEARCHING
    currentState = STATE.SEARCHING;
    setLoading(true);
    clearTransientUI();
    appendMessage('user', query);
    chatHistory.push({role:'user', content: query});
    showSkeletons();
    log('STATE ->', currentState, 'QUERY ->', query);

    try{
      const res = await fetch(CONFIG.CLOUD_FUNCTION_URL,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ chatHistory })
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();

      document.getElementById('loading-skeletons')?.remove();

      if(data.success){
        const text=(data.responseText||'').trim();
        if(text) appendMessage('bot', text);

        const hadAnyBefore = document.querySelector('.cards-container') !== null;
        const countBefore = shownProductUrls.size;

        if(data.products && data.products.length){
          renderProductCards(data.products, append);
          if(!hadAnyBefore) renderResultsActions();
        }else{
          // Sin productos
          appendMessage('bot', 'No encontr√© resultados con esos filtros. ¬øAjustamos el precio o probamos otra categor√≠a?');
          // Vuelve a filtros para permitir ajuste
          renderFilters(currentState===STATE.FALLBACK);
        }

        log('RESULTS ->', shownProductUrls.size - countBefore, 'nuevos');
        // Estado final
        currentState = data.products && data.products.length ? STATE.RESULTS : (FACETS_BY_CATEGORY[activeCategory]?STATE.FILTERS:STATE.FALLBACK);
      }else{
        appendMessage('bot', 'Error del servidor: '+data.responseText);
        currentState = FACETS_BY_CATEGORY[activeCategory]?STATE.FILTERS:STATE.FALLBACK;
      }
    }catch(e){
      console.error(e);
      document.getElementById('loading-skeletons')?.remove();
      appendMessage('bot','Disculpa, ha ocurrido un error de conexi√≥n.');
      currentState = FACETS_BY_CATEGORY[activeCategory]?STATE.FILTERS:STATE.FALLBACK;
    }finally{
      setLoading(false);
      log('STATE ->', currentState);
    }
  }

  // ======= Pintar resultados + acciones =======
  function renderProductCards(products, append){
    if(!append) shownProductUrls.clear();
    let container = append ? chatContainer.querySelector('.cards-container') : null;
    if(!append || !container){
      container=document.createElement('div'); container.className='cards-container';
      chatContainer.appendChild(container);
    }

    products.forEach(p=>{
      if(!p.url || shownProductUrls.has(p.url)) return;
      shownProductUrls.add(p.url);

      const a=document.createElement('a'); a.className='product-card'; a.href=p.url; a.target='_blank'; a.rel='nofollow sponsored noopener';
      const img=document.createElement('img'); img.className='product-image'; img.src=p.imagen||''; img.alt=p.nombre||'Producto';

      const details=document.createElement('div'); details.className='product-details';
      const title=document.createElement('div'); title.className='product-title'; title.textContent=p.nombre||'';
      const bottom=document.createElement('div'); bottom.className='product-info-bottom';
      const price=document.createElement('div'); price.className='product-price'; price.textContent=p.precio||'';
      const store=document.createElement('div'); store.className='product-store'; store.textContent=p.tienda ? `eBay ${p.tienda}` : 'eBay';

      bottom.appendChild(price); bottom.appendChild(store);
      details.appendChild(title); details.appendChild(bottom);
      a.appendChild(img); a.appendChild(details);
      container.appendChild(a);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function renderResultsActions(){
    document.getElementById('results-actions')?.remove();
    const row=document.createElement('div'); row.className='results-actions'; row.id='results-actions';

    const moreBtn=document.createElement('button'); moreBtn.className='btn'; moreBtn.innerText='M√°s resultados';
    moreBtn.onclick=async ()=>{ moreBtn.disabled=true; await moreResults(); moreBtn.disabled=false; };

    const priceBtn=document.createElement('button'); priceBtn.className='btn secondary'; priceBtn.innerText='Ajustar precio';
    priceBtn.onclick=focusPriceFilter;

    const newBtn=document.createElement('button'); newBtn.className='btn secondary'; newBtn.innerText='Nueva b√∫squeda';
    newBtn.onclick=resetToLanding;

    row.appendChild(moreBtn); row.appendChild(priceBtn); row.appendChild(newBtn);
    chatContainer.appendChild(row);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function focusPriceFilter(){
    // Garantiza que los filtros est√©n visibles
    if(currentState!==STATE.FILTERS && currentState!==STATE.FALLBACK){
      renderFilters(currentState===STATE.FALLBACK);
    }
    const chipsContainer = document.getElementById('chips-container');
    let priceLabel = Array.from(chipsContainer.querySelectorAll('.chips-group-label')).find(el=>/precio/i.test(el.textContent||''));

    if(!priceLabel){
      const moreBtn = Array.from(chipsContainer.querySelectorAll('button')).find(b=>b.textContent?.toLowerCase().includes('m√°s filtros'));
      if(moreBtn){ moreBtn.click(); }
      priceLabel = Array.from(chipsContainer.querySelectorAll('.chips-group-label')).find(el=>/precio/i.test(el.textContent||''));
    }
    if(priceLabel){
      const row = priceLabel.parentElement;
      row.classList.add('price-highlight');
      row.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>row.classList.remove('price-highlight'),1500);
    }
  }

  function resetToLanding(){
    activeCategory=null;
    activeFilters={};
    moreFiltersExpanded={};
    shownProductUrls.clear();
    clearTransientUI();

    // Limpia timeline excepto cabecera y deja solo el nuevo landing
    while(chatContainer.firstChild) chatContainer.removeChild(chatContainer.firstChild);
    renderLanding();
  }

  // ======= Entrada cl√°sica (mensaje manual) =======
  async function sendFreeText(){
    const msg = userInput.value.trim();
    if(!msg) return;
    appendMessage('user', msg);
    chatHistory.push({role:'user', content:msg});
    userInput.value='';

    // Si el usuario escribe ‚Äúbusco X‚Äù manual, lo tratamos como categor√≠a y vamos a filtros
    if(/^busco\s+/i.test(msg)){
      const lower = msg.toLowerCase();
      const known = Object.keys(FACETS_BY_CATEGORY).find(k=>lower.includes(k.toLowerCase()));
      activeCategory = known || msg.replace(/^busco\s+/i,'').trim();
      renderFilters(!known);
      return;
    }

    // Si estamos en resultados y escribe algo como ‚Äúm√°s resultados‚Äù, lo encaminamos:
    if(currentState===STATE.RESULTS && /m√°s resultados|mas resultados/i.test(msg)){ await moreResults(); return; }

    // Si no encaja, mantenemos conversaci√≥n m√≠nima sin romper flujo:
    appendMessage('bot','Dime qu√© categor√≠a quieres (o pulsa una) y ajustamos filtros para buscarte chollos.');
  }

  // ======= Init =======
  sendButton.addEventListener('click', sendFreeText);
  userInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey) sendFreeText(); });

  document.addEventListener('DOMContentLoaded', renderLanding);
</script>

</body>
</html>
