<!DOCTYPE html>
<html>
<head>
<base target="_top">
<title>Tu Gregario - Ciclismo Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    :root { --main-bg: #1a1a2e; --chat-bg: #24243e; --bot-bubble: #3f3f5f; --user-bubble: #4e44b0; --highlight: #ffcc00; --text-primary: #e0e0e0; --text-secondary: #aaa; --border-color: #33334f; }
    html, body { height: 100%; margin: 0; padding: 0; width: 100%; font-family: 'Poppins', Arial, sans-serif; background-color: var(--main-bg); }
    body { display: flex; justify-content: center; align-items: flex-start; }
    #main-wrapper { width: 100%; max-width: 700px; min-height: 100vh; display: flex; flex-direction: column; background-color: var(--chat-bg); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
    #chat-header { display: flex; align-items: center; padding: 10px 15px; background-color: var(--main-bg); border-bottom: 1px solid var(--border-color); color: white; position: sticky; top: 0; z-index: 10; }
    #chat-header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    #chat-container { flex-grow: 1; padding: 15px; overflow-y: scroll; display: flex; flex-direction: column; gap: 10px; }
    .message { padding: 10px 15px; border-radius: 20px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
    .user { background-color: var(--user-bubble); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
    .bot { background-color: var(--bot-bubble); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 5px; }
    .bot strong { color: var(--highlight); }
    .cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; width: 100%; padding-top: 10px; }
    .product-card { background-color: var(--bot-bubble); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; text-decoration: none; color: var(--text-primary); transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #4a4a6a; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
    .product-image { width: 100%; height: 140px; background-color: #2e2e48; object-fit: cover; }
    .product-details { padding: 10px; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; height: 120px; }
    .product-title { font-size: 14px; font-weight: 600; line-height: 1.3; margin: 0 0 5px 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
    .product-info-bottom { margin-top: auto; }
    .product-price { font-size: 16px; font-weight: 700; color: var(--highlight); }
    .product-store { font-size: 12px; color: var(--text-secondary); }
    #input-container { display: flex; padding: 10px; border-top: 1px solid var(--border-color); background-color: var(--chat-bg); position: sticky; bottom: 0; }
    #user-input { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 25px; background-color: #33334f; color: white; font-size: 16px; margin-right: 10px; outline: none; }
    #send-button { background-color: var(--user-bubble); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s; }
    
    /* === NUEVOS ESTILOS PARA LA INTERFAZ INTERACTIVA === */
    .chips-container { display: flex; flex-direction: column; gap: 12px; align-self: flex-start; width: 100%; margin-top: 12px; }
    .chips-row { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
    .chip { background: rgba(255,255,255,.08); color:#ddd; border:1px solid rgba(255,255,255,.12); padding:8px 14px; border-radius:999px; font-size:.9rem; cursor:pointer; user-select:none; transition: all .2s ease; }
    .chip:hover { transform: translateY(-1px); background: rgba(255,255,255,.12); }
    .chip.selected { background-color: var(--user-bubble); border-color: #8d85f3; color: white; }
    .chips-group-label { color:#9aa; font-size:.8rem; margin-right:8px; width: 70px; text-align: right;}
    .apply-filters-btn { background: #5a4ae3; color: #fff; border: none; border-radius: 10px; padding: 10px 16px; font-size: .95rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,.25); width: 100%; margin-top: 10px; font-weight: 600; }
    .apply-filters-btn:hover { filter: brightness(1.1); }
    .ge-skeletons { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px; padding-top:10px; width: 100%;}
    .ge-skel { background: linear-gradient(90deg, var(--bot-bubble) 25%, #4a4a6a 37%, var(--bot-bubble) 63%); background-size: 400% 100%; animation: geShimmer 1.4s infinite; border-radius:12px; height:282px; }
    @keyframes geShimmer { 0% {background-position: 100% 0} 100% {background-position: -100% 0} }
</style>
</head>
<body>

<div id="main-wrapper">
    <div id="chat-header"><h1>Tu Gregario de Ciclismo Online</h1></div>
    <div id="chat-container"></div>
    <div id="input-container">
        <input type="text" id="user-input" placeholder="Preg√∫ntale a Tu Gregario..." autofocus>
        <button id="send-button"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.873L5.999 12zm0 0h7.5" /></svg></button>
    </div>
</div>

<script>
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chatContainer = document.getElementById('chat-container');
    let chatHistory = [];
    let activeFilters = {}; // Almacena los filtros seleccionados

    const CONFIG = {
        intents: [
            'GPS / Ciclocomputadores', 'Rodillos Inteligentes', 'Potenci√≥metros', 'Ruedas', 
            'Cascos', 'Zapatillas', 'Culottes', 'Chaquetas', 'Luces Potentes', 'Nutrici√≥n'
        ],
        refine: {
            disciplina: { label:"Disciplina", chips:["Carretera","MTB","Gravel"] },
            talla:      { label:"Talla",      chips:["S","M","L","XL"] },
            precio:     { label:"Precio",     chips:["< 50‚Ç¨","50‚Äì100‚Ç¨","100‚Äì200‚Ç¨"] },
        },
        CLOUD_FUNCTION_URL: 'https://gregario-chatbot-738677149871.europe-west1.run.app'
    };
    
    // --- L√ìGICA PRINCIPAL ---

    async function sendMessage(messageText = null) {
        const message = messageText !== null ? messageText : userInput.value.trim();
        if (message === '') return;

        setLoading(true);
        removeExistingChips();
        appendMessage('user', message);
        chatHistory.push({ role: 'user', content: message });
        if(messageText === null) userInput.value = '';
        
        showLoadingSkeletons();
        
        try {
            const response = await fetch(CONFIG.CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chatHistory })
            });

            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const data = await response.json();
            
            removeLoadingSkeletons();

            if (data.success) {
                chatHistory.push({ role: 'assistant', content: data.responseText });
                appendMessage('bot', data.responseText);
                
                if (data.products && data.products.length > 0) {
                    renderProductCards(data.products);
                } else {
                    showRefinementChips();
                }
            } else {
                appendMessage('bot', 'Error del servidor: ' + data.responseText);
            }

        } catch (error) {
            console.error('Error de Fetch:', error);
            removeLoadingSkeletons();
            appendMessage('bot', 'Disculpa, ha ocurrido un error de conexi√≥n.');
        } finally {
            setLoading(false);
        }
    }

    // --- FUNCIONES DE UI ---

    function appendMessage(sender, message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.innerHTML = message;
        chatContainer.appendChild(messageElement);
        scrollToBottom();
    }
    
    function renderProductCards(products) {
        // (c√≥digo sin cambios)
    }
    
    function showInitialIntentChips() {
        const chips = CONFIG.intents.map(label => ({ label, value: `Busco ${label}` }));
        const chipsElement = createChipsRow(chips, false); // false = no es multiselecci√≥n
        
        const container = document.createElement('div');
        container.className = 'chips-container';
        container.id = 'chips-container';
        container.appendChild(chipsElement);
        
        chatContainer.appendChild(container);
        scrollToBottom();
    }
    
    function showRefinementChips() {
        activeFilters = {}; // Resetea filtros activos
        const container = document.createElement('div');
        container.className = 'chips-container';
        container.id = 'chips-container';
        
        Object.entries(CONFIG.refine).forEach(([key, def]) => {
            const chipsData = def.chips.map(label => ({ label, value: label, group: key }));
            const chipsRow = createChipsRow(chipsData, true, def.label); // true = multiselecci√≥n
            container.appendChild(chipsRow);
        });
        
        chatContainer.appendChild(container);
        scrollToBottom();
    }
    
    function createChipsRow(chipsData, isMultiSelect, label = null) {
        const row = document.createElement('div');
        row.className = 'chips-row';

        if(label) {
            const labelElement = document.createElement('span');
            labelElement.className = 'chips-group-label';
            labelElement.innerText = label;
            row.appendChild(labelElement);
        }

        chipsData.forEach(chipData => {
            const chipElement = document.createElement('div');
            chipElement.className = 'chip';
            chipElement.innerText = chipData.label;

            if (isMultiSelect) {
                chipElement.onclick = () => handleRefinementClick(chipElement, chipData);
            } else {
                chipElement.onclick = () => sendMessage(chipData.value);
            }
            row.appendChild(chipElement);
        });
        return row;
    }

    function handleRefinementClick(chipElement, chipData) {
        // Activa o desactiva el chip
        chipElement.classList.toggle('selected');
        
        // Actualiza el estado de los filtros
        if (chipElement.classList.contains('selected')) {
            activeFilters[chipData.group] = chipData.value;
        } else {
            delete activeFilters[chipData.group];
        }
        
        // Muestra u oculta el bot√≥n de "Aplicar"
        const hasActiveFilters = Object.keys(activeFilters).length > 0;
        let applyBtn = document.getElementById('apply-filters-btn');

        if (hasActiveFilters && !applyBtn) {
            applyBtn = document.createElement('button');
            applyBtn.id = 'apply-filters-btn';
            applyBtn.className = 'apply-filters-btn';
            applyBtn.innerText = '‚ú® Aplicar Filtros y Buscar';
            applyBtn.onclick = applyFilters;
            document.getElementById('chips-container').appendChild(applyBtn);
        } else if (!hasActiveFilters && applyBtn) {
            applyBtn.remove();
        }
    }
    
    function applyFilters() {
        let messageParts = [];
        const baseQuery = chatHistory.find(msg => msg.role === 'user' && msg.content.toLowerCase().startsWith('busco'))?.content || 'producto';

        if (activeFilters.disciplina) messageParts.push(`para ${activeFilters.disciplina}`);
        if (activeFilters.talla) messageParts.push(`en talla ${activeFilters.talla}`);
        if (activeFilters.precio) messageParts.push(`con presupuesto ${activeFilters.precio.replace('‚Ç¨','')}`);
        
        const fullMessage = `${baseQuery} ${messageParts.join(' ')}`;
        sendMessage(fullMessage);
    }
    
    function showLoadingSkeletons() { /* (c√≥digo sin cambios) */ }
    function removeLoadingSkeletons() { /* (c√≥digo sin cambios) */ }
    function removeExistingChips() {
        document.getElementById('chips-container')?.remove();
    }
    function scrollToBottom() { /* (c√≥digo sin cambios) */ }
    function setLoading(isLoading) { /* (c√≥digo sin cambios) */ }

    // --- INICIALIZACI√ìN ---
    sendButton.addEventListener('click', () => sendMessage(null));
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(null); });

    document.addEventListener('DOMContentLoaded', () => {
        const welcomeMessage = "<strong>Soy Tu Gregario üö¥‚Äç‚ôÇÔ∏è.</strong> Busco gangas ciclistas en varios eBay por ti.<br><br><strong>¬øQu√© necesitas hoy?</strong>";
        appendMessage('bot', welcomeMessage);
        showInitialIntentChips();
        userInput.focus();
    });
</script>

</body>
</html>


