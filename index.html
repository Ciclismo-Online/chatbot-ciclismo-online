<!DOCTYPE html>
<html>
<head>
<base target="_top">
<title>Tu Gregario - Ciclismo Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    html, body { height: 100%; margin: 0; padding: 0; width: 100%; }
    body { font-family: 'Poppins', Arial, sans-serif; background-color: #1a1a2e; display: flex; justify-content: center; align-items: flex-start; }
    #main-wrapper { width: 100%; max-width: 700px; min-height: 100vh; display: flex; flex-direction: column; background-color: #24243e; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
    #chat-header { display: flex; align-items: center; padding: 10px 15px; background-color: #1a1a2e; border-bottom: 1px solid #33334f; color: white; }
    #chat-header span { font-size: 24px; margin-right: 12px; }
    #chat-header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    #chat-container { flex-grow: 1; padding: 15px; overflow-y: scroll; display: flex; flex-direction: column; gap: 10px; }
    .message { padding: 10px 15px; border-radius: 20px; max-width: 80%; word-wrap: break-word; }
    .user { background-color: #4e44b0; color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
    .bot { background-color: #3f3f5f; color: #e0e0e0; align-self: flex-start; border-bottom-left-radius: 5px; }
    .bot strong { color: #ffcc00; }
    #input-container { display: flex; padding: 10px; border-top: 1px solid #33334f; background-color: #24243e; position: sticky; bottom: 0; }
    #user-input { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 25px; background-color: #33334f; color: white; font-size: 16px; margin-right: 10px; outline: none; }
    #send-button { background-color: #4e44b0; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s; }
    #send-button:hover:not(:disabled) { background-color: #6a5bcd; }
    #send-button:disabled { opacity: 0.5; cursor: not-allowed; }
    .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #ffcc00; width: 25px; height: 25px; animation: spin 1s linear infinite; align-self: flex-start; margin: 10px 15px; }
    
    /* --- ESTILOS PARA LAS TARJETAS DE PRODUCTO --- */
    .cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; width: 100%; padding-top: 10px; }
    .product-card { background-color: #3f3f5f; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; text-decoration: none; color: #e0e0e0; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #4a4a6a; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
    .product-image { width: 100%; height: 140px; background-color: #2e2e48; object-fit: cover; }
    .product-details { padding: 10px; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; height: 110px; }
    .product-title { font-size: 14px; font-weight: 600; line-height: 1.3; margin: 0 0 5px 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
    .product-info-bottom { margin-top: auto; }
    .product-price { font-size: 16px; font-weight: 700; color: #ffcc00; }
    .product-store { font-size: 12px; color: #aaa; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="main-wrapper">
    <div id="chat-header"><span>‚öôÔ∏è</span><h1>Tu Gregario de Ciclismo Online</h1></div>
    <div id="chat-container"></div>
    <div id="input-container">
        <input type="text" id="user-input" placeholder="Preg√∫ntale a Tu Gregario..." autofocus>
        <button id="send-button"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.873L5.999 12zm0 0h7.5" /></svg></button>
    </div>
</div>

<script>
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chatContainer = document.getElementById('chat-container');
    let chatHistory = [];

    function appendMessage(sender, message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.innerHTML = message;
        chatContainer.appendChild(messageElement);
        scrollToBottom();
    }
    
    function renderProductCards(products) {
        if (!products || products.length === 0) return;

        const container = document.createElement('div');
        container.className = 'cards-container';

        products.forEach(product => {
            const cardLink = document.createElement('a');
            cardLink.href = product.url;
            cardLink.target = '_blank';
            cardLink.rel = 'noopener noreferrer';
            cardLink.className = 'product-card';

            const placeholderImage = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // Imagen transparente

            cardLink.innerHTML = `
                <img src="${product.imagen || placeholderImage}" class="product-image" alt="${product.nombre}" onerror="this.style.display='none';">
                <div class="product-details">
                    <p class="product-title">${product.nombre}</p>
                    <div class="product-info-bottom">
                        <div class="product-price">${product.precio}</div>
                        <div class="product-store">${product.tienda}</div>
                    </div>
                </div>
            `;
            container.appendChild(cardLink);
        });
        
        chatContainer.appendChild(container);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (message === '') return;

        setLoading(true);
        appendMessage('user', message);
        chatHistory.push({ role: 'user', content: message });
        userInput.value = '';

        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        spinner.id = 'loading-spinner';
        chatContainer.appendChild(spinner);
        scrollToBottom();
        
        const CLOUD_FUNCTION_URL = 'https://gregario-chatbot-738677149871.europe-west1.run.app';

        try {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chatHistory: chatHistory })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.responseText || `Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            document.getElementById('loading-spinner')?.remove();

            if (data.success) {
                chatHistory.push({ role: 'assistant', content: data.responseText });
                
                appendMessage('bot', data.responseText);
                renderProductCards(data.products);
            } else {
                appendMessage('bot', 'Error del servidor: ' + data.responseText);
            }

        } catch (error) {
            console.error('Error de Fetch:', error);
            document.getElementById('loading-spinner')?.remove();
            appendMessage('bot', 'Disculpa, ha ocurrido un error de conexi√≥n.');
        } finally {
            setLoading(false);
        }
    }
    
    function setLoading(isLoading) {
        userInput.disabled = isLoading;
        sendButton.disabled = isLoading;
        if (!isLoading) userInput.focus();
    }

    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    document.addEventListener('DOMContentLoaded', () => {
        const welcomeMessage = "<strong>¬°Hola! Soy Tu Gregario, tu asistente experto de Ciclismo Online.</strong> üö¥<br><br>Ahora busco ofertas en eBay de varios pa√≠ses para darte m√°s opciones.<br><br><strong>Dime qu√© buscas</strong> y me pongo a ello.";
        appendMessage('bot', welcomeMessage);
        userInput.focus();
    });
</script>
</body>
</html>
