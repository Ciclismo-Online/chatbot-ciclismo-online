<!DOCTYPE html>
<html>
<head>
<base target="_top">
<title>Tu Gregario - Ciclismo Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
Â  :root{--main-bg:#1a1a2e;--chat-bg:#24243e;--bot-bubble:#3f3f5f;--user-bubble:#4e44b0;--highlight:#ffcc00;--text-primary:#e0e0e0;--text-secondary:#aaa;--border-color:#33334f;}
Â  html,body{height:100%;margin:0;padding:0;width:100%;font-family:'Poppins',Arial,sans-serif;background-color:var(--main-bg);}
Â  body{display:flex;justify-content:center;align-items:flex-start;}
Â  #main-wrapper{width:100%;max-width:700px;min-height:100vh;display:flex;flex-direction:column;background-color:var(--chat-bg);box-shadow:0 4px 12px rgba(0,0,0,.5);}
Â  #chat-header{display:flex;align-items:center;padding:10px 15px;background-color:var(--main-bg);border-bottom:1px solid var(--border-color);color:white;position:sticky;top:0;z-index:10;}
Â  #chat-header h1{font-size:18px;font-weight:600;margin:0;}
Â  #chat-container{flex-grow:1;padding:15px;overflow-y:scroll;display:flex;flex-direction:column;gap:10px;}
Â  .message{padding:10px 15px;border-radius:20px;max-width:80%;word-wrap:break-word;line-height:1.5;}
Â  .user{background-color:var(--user-bubble);color:white;align-self:flex-end;border-bottom-right-radius:5px;}
Â  .bot{background-color:var(--bot-bubble);color:var(--text-primary);align-self:flex-start;border-bottom-left-radius:5px;}
Â  .bot strong{color:var(--highlight);}

Â  .cards-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;width:100%;padding-top:10px;}
Â  .product-card{background-color:var(--bot-bubble);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;text-decoration:none;color:var(--text-primary);transition:transform .2s,box-shadow .2s;border:1px solid #4a4a6a;}
Â  .product-card:hover{transform:translateY(-5px);box-shadow:0 6px 15px rgba(0,0,0,.4);}
Â  .product-image{width:100%;height:140px;background-color:#2e2e48;object-fit:cover;}
Â  .product-details{padding:10px;display:flex;flex-direction:column;flex-grow:1;justify-content:space-between;height:120px;}
Â  .product-title{font-size:14px;font-weight:600;line-height:1.3;margin:0 0 5px 0;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;}
Â  .product-info-bottom{margin-top:auto;}
Â  .product-price{font-size:16px;font-weight:700;color:var(--highlight);}
Â  .product-store{font-size:12px;color:var(--text-secondary);}

Â  #input-container{display:flex;padding:10px;border-top:1px solid var(--border-color);background-color:var(--chat-bg);position:sticky;bottom:0;}
Â  #user-input{flex-grow:1;padding:10px 15px;border:none;border-radius:25px;background-color:#33334f;color:white;font-size:16px;margin-right:10px;outline:none;}
Â  #send-button{background-color:var(--user-bubble);color:white;border:none;border-radius:50%;width:45px;height:45px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background-color .3s;}

Â  /* Chips / filtros */
Â  .chips-container{display:flex;flex-direction:column;gap:12px;align-self:flex-start;width:100%;margin-top:12px;}
Â  .chips-hint{color:#9aa;font-size:.85rem;margin:2px 0 4px 4px;}
Â  .chips-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;}
Â  .chip{background:rgba(255,255,255,.08);color:#ddd;border:1px solid rgba(255,255,255,.12);padding:8px 14px;border-radius:999px;font-size:.9rem;cursor:pointer;user-select:none;transition:all .2s ease;}
Â  .chip:hover{transform:translateY(-1px);background:rgba(255,255,255,.12);}
Â  .chip.selected{background-color:var(--user-bubble);border-color:#8d85f3;color:white;}
Â  .chip.plus{border-style:dashed;}
Â  .chips-group-label{color:#9aa;font-size:.8rem;margin-right:8px;width:90px;text-align:right;}
Â  .apply-filters-btn{background:#5a4ae3;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-size:.95rem;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25);font-weight:600; flex-grow: 1; text-align: center;}
Â  .clear-filters-btn{background:transparent;color:#bbb;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:8px 12px;font-size:.85rem;cursor:pointer;}

Â  /* Skeletons */
Â  .ge-skeletons{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;padding-top:10px;width:100%;}
Â  .ge-skel{background:linear-gradient(90deg,var(--bot-bubble) 25%,#4a4a6a 37%,var(--bot-bubble) 63%);background-size:400% 100%;animation:geShimmer 1.4s infinite;border-radius:12px;height:282px;}
Â  @keyframes geShimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

Â  /* Modal â€œMÃ¡s categorÃ­asâ€ */
Â  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50;}
Â  .modal{background:var(--chat-bg);border:1px solid var(--border-color);border-radius:16px;padding:16px;max-width:640px;width:calc(100% - 32px);box-shadow:0 10px 30px rgba(0,0,0,.45);}
Â  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
Â  .modal-title{color:#fff;font-size:16px;font-weight:600;}
Â  .modal-close{background:transparent;color:#ddd;border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:8px;cursor:pointer;}
Â  .modal-content{display:flex;flex-wrap:wrap;gap:.5rem;max-height:60vh;overflow:auto;}

Â  /* Botonera de resultados */
Â  .results-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:10px;}
Â  .results-actions .btn{background:#5a4ae3;border:none;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25);}
Â  .results-actions .btn.secondary{background:transparent;color:#ddd;border:1px solid rgba(255,255,255,.2);}
Â  .price-highlight{box-shadow:0 0 0 2px #ffd54f inset;animation:blink 1.2s ease 2;}
Â  @keyframes blink{50%{box-shadow:0 0 0 2px transparent inset}}
</style>
</head>
<body>

<div id="main-wrapper">
Â  <div id="chat-header"><h1>Tu Gregario de Ciclismo Online</h1></div>
Â  <div id="chat-container"></div>
Â  <div id="input-container">
Â  Â  <input type="text" id="user-input" placeholder="PregÃºntale a Tu Gregario..." autofocus>
Â  Â  <button id="send-button"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.873L5.999 12zm0 0h7.5"/></svg></button>
Â  </div>
</div>

<div id="more-cats-backdrop" class="modal-backdrop">
Â  <div class="modal">
Â  Â  <div class="modal-header">
Â  Â  Â  <div class="modal-title">MÃ¡s categorÃ­as</div>
Â  Â  Â  <button id="modal-close" class="modal-close">Cerrar</button>
Â  Â  </div>
Â  Â  <div id="more-cats-content" class="modal-content"></div>
Â  </div>
</div>

<script>
Â  const userInput = document.getElementById('user-input');
Â  const sendButton = document.getElementById('send-button');
Â  const chatContainer = document.getElementById('chat-container');

Â  const modalBackdrop = document.getElementById('more-cats-backdrop');
Â  const modalCloseBtn = document.getElementById('modal-close');
Â  const modalContent = document.getElementById('more-cats-content');

Â  let chatHistory = [];
Â  let activeFilters = {};
Â  let activeCategory = null;
Â  let modeFallback = false;
Â  let moreFiltersExpanded = {};
Â  let shownProductUrls = new Set();
Â  let lastQueryMessage = '';

Â  const CONFIG = {
Â  Â  intents: [
Â  Â  Â  'GPS / Ciclocomputadores','Rodillos Inteligentes','PotenciÃ³metros','Ruedas',
Â  Â  Â  'Cascos','Zapatillas','Culottes','Chaquetas','Luces Potentes','NutriciÃ³n','+'
Â  Â  ],
Â  Â  CLOUD_FUNCTION_URL: 'https://gregario-chatbot-738677149871.europe-west1.run.app'
Â  };

Â  const FACETS_BY_CATEGORY = {
Â  Â  'Culottes': {
Â  Â  Â  Disciplina:['Carretera','MTB','Gravel','Indoor'],
Â  Â  Â  Talla:['XS','S','M','L','XL','XXL'],
Â  Â  Â  Precio:['<50â‚¬','50â€“100â‚¬','100â€“150â‚¬','150â€“200â‚¬','200â€“300â‚¬','+300â‚¬'],
Â  Â  Â  Badana:['4â€“6h','6â€“8h','+8h','TriatlÃ³n'],
Â  Â  Â  Temporada:['Verano','Invierno','Todo el aÃ±o'],
Â  Â  Â  Material:['Lycra','CompresiÃ³n','TÃ©rmico','Impermeable']
Â  Â  },
Â  Â  'Cascos': {
Â  Â  Â  Disciplina:['Carretera','MTB','Gravel','Enduro','Urbano'],
Â  Â  Â  Talla:['S','M','L','XL'],
Â  Â  Â  Precio:['<60â‚¬','60â€“100â‚¬','100â€“150â‚¬','150â€“200â‚¬','200â€“300â‚¬','+300â‚¬'],
Â  Â  Â  Seguridad:['MIPS','SPIN','WaveCel','KinetiCore'],
Â  Â  Â  Peso:['<250g','250â€“300g','300â€“350g','+350g']
Â  Â  },
Â  Â  'Zapatillas': {
Â  Â  Â  Disciplina:['Carretera','MTB','Gravel','TriatlÃ³n'],
Â  Â  Â  'Talla EU':['38','39','40','41','42','43','44','45','46','47'],
Â  Â  Â  Precio:['<80â‚¬','80â€“120â‚¬','120â€“180â‚¬','180â€“250â‚¬','+250â‚¬'],
Â  Â  Â  Cala:['SPD','SPD-SL','Look KEO'],
Â  Â  Â  Rigidez:['Normal','Alta','Carbono'],
Â  Â  Â  VentilaciÃ³n:['Alta','Media','Cerrada']
Â  Â  },
Â  Â  'GPS / Ciclocomputadores': {
Â  Â  Â  NavegaciÃ³n:['Mapas','Seguimiento bÃ¡sico'],
Â  Â  Â  Conectividad:['ANT+/BT','WiFi'],
Â  Â  Â  Precio:['<100â‚¬','100â€“200â‚¬','200â€“300â‚¬','300â€“500â‚¬','+500â‚¬'],
Â  Â  Â  MÃ©tricas:['PotenciÃ³metro','Entrenos','Segmentos']
Â  Â  },
Â  Â  'Rodillos Inteligentes': {
Â  Â  Â  Tipo:['Directo','Wheel-on'],
Â  Â  Â  Apps:['Zwift','Rouvy','TrainerRoad'],
Â  Â  Â  Precio:['<300â‚¬','300â€“500â‚¬','500â€“800â‚¬','800â€“1200â‚¬','+1200â‚¬'],
Â  Â  Â  Potencia:['1000W+','1500W+','2000W+'],
Â  Â  Â  SimulaciÃ³n:['12%+','16%+','20%+']
Â  Â  },
Â  Â  'PotenciÃ³metros': {
Â  Â  Â  Tipo:['Biela','Pedal','Spider','Buje'],
Â  Â  Â  Compatibilidad:['Shimano','SRAM','Rotor','Campagnolo'],
Â  Â  Â  Precio:['<300â‚¬','300â€“500â‚¬','500â€“800â‚¬','800â€“1200â‚¬','+1200â‚¬'],
Â  Â  Â  MediciÃ³n:['1 lado','2 lados'],
Â  Â  Â  'Longitud biela':['165','170','172.5','175'],
Â  Â  Â  PrecisiÃ³n:['Â±1%','Â±2%','Â±3%']
Â  Â  },
Â  Â  'Ruedas': {
Â  Â  Â  TamaÃ±o:['700C','29"','27.5"'],
Â  Â  Â  Freno:['Disco','Zapata'],
Â  Â  Â  Precio:['<200â‚¬','200â€“400â‚¬','400â€“700â‚¬','700â€“1200â‚¬','+1200â‚¬'],
Â  Â  Â  Material:['Aluminio','Carbono'],
Â  Â  Â  Tubeless:['SÃ­','No']
Â  Â  },
Â  Â  'Luces Potentes': {
Â  Â  Â  LÃºmenes:['300+','600+','1000+'],
Â  Â  Â  AutonomÃ­a:['<2h','2â€“4h','4h+'],
Â  Â  Â  Precio:['<30â‚¬','30â€“60â‚¬','60â€“100â‚¬','100â€“150â‚¬','+150â‚¬'],
Â  Â  Â  Montaje:['Manillar','Casco']
Â  Â  },
Â  Â  'Chaquetas': {
Â  Â  Â  Disciplina:['Carretera','MTB','Gravel','Urbano'],
Â  Â  Â  Talla:['XS','S','M','L','XL','XXL'],
Â  Â  Â  Precio:['<60â‚¬','60â€“100â‚¬','100â€“150â‚¬','150â€“200â‚¬','200â€“300â‚¬','+300â‚¬'],
Â  Â  Â  EstaciÃ³n:['Invierno','Entretiempo','Lluvia'],
Â  Â  Â  Membrana:['>5.000 mm','>10.000 mm','>20.000 mm']
Â  Â  },
Â  Â  'NutriciÃ³n': {
Â  Â  Â  Tipo:['Gel','Barrita','IsotÃ³nica','Recuperador'],
Â  Â  Â  CarboHora:['30â€“60g','60â€“90g'],
Â  Â  Â  Precio:['<10â‚¬','10â€“20â‚¬','20â€“40â‚¬','40â€“80â‚¬','+80â‚¬'],
Â  Â  Â  CafeÃ­na:['SÃ­','No']
Â  Â  }
Â  };

Â  const EXTRA_CATEGORIES = [
Â  Â  'Gafas','Guantes','Camisetas interiores','Chubasqueros','Calcetines tÃ©rmicos',
Â  Â  'Multiherramientas','Bombas / COâ‚‚','Kits tubeless','Cadenas','Pastillas de freno',
Â  Â  'Lubricantes','Ceras','Limpiadores','Portabidones','Bidones',
Â  Â  'Soportes mÃ³vil/GPS','Luces traseras','Cintas de manillar','PuÃ±os',
Â  Â  'Sensores HR/Vel/Cad'
Â  ];

Â  const GLOBAL_MIN_FILTERS = { Precio:['<50â‚¬','50â€“100â‚¬','100â€“200â‚¬','200â€“300â‚¬','+300â‚¬'] };

Â  // ---------- Principal ----------
Â  async function sendMessage(messageText=null){
Â  Â  const message = messageText!==null ? messageText : userInput.value.trim();
Â  Â  if(message==='') return;

Â  Â  setLoading(true);
Â  Â  removeExistingChips();
Â  Â  appendMessage('user', message);
Â  Â  chatHistory.push({role:'user', content:message});
Â  Â  if(messageText===null) userInput.value='';

Â  Â  showLoadingSkeletons();
Â  Â  detectActiveCategoryFromMessage(message);
Â  Â  lastQueryMessage = message;

Â  Â  try{
Â  Â  Â  const response = await fetch(CONFIG.CLOUD_FUNCTION_URL,{
Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  body:JSON.stringify({chatHistory})
Â  Â  Â  });
Â  Â  Â  if(!response.ok) throw new Error(`Error HTTP: ${response.status}`);
Â  Â  Â  const data = await response.json();

Â  Â  Â  removeLoadingSkeletons();

Â  Â  Â  if(data.success){
Â  Â  Â  Â  const text = (data.responseText||'').trim();
Â  Â  Â  Â  chatHistory.push({role:'assistant', content:text});
Â  Â  Â  Â  appendMessage('bot', text);

Â  Â  Â  Â  if(data.products && data.products.length>0){
Â  Â  Â  Â  Â  renderProductCards(data.products);
Â  Â  Â  Â  Â  renderResultsActions();
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  appendMessage('bot', 'No he encontrado resultados para esa bÃºsqueda. Â¿Quieres probar a ajustar los filtros o buscar otra cosa?');
Â  Â  Â  Â  }
Â  Â  Â  }else{
Â  Â  Â  Â  appendMessage('bot','Error del servidor: '+data.responseText);
Â  Â  Â  }
Â  Â  }catch(e){
Â  Â  Â  console.error('Error de Fetch:',e);
Â  Â  Â  removeLoadingSkeletons();
Â  Â  Â  appendMessage('bot','Disculpa, ha ocurrido un error de conexiÃ³n.');
Â  Â  }finally{
Â  Â  Â  setLoading(false);
Â  Â  }
Â  }

Â  // ---------- UI ----------
Â  function appendMessage(sender, message){
Â  Â  const el=document.createElement('div');
Â  Â  el.classList.add('message',sender);
Â  Â  el.innerHTML=message;
Â  Â  chatContainer.appendChild(el);
Â  Â  scrollToBottom();
Â  }

Â  function renderProductCards(products){
Â  Â  const container=document.createElement('div');
Â  Â  container.className='cards-container';

Â  Â  products.forEach(p=>{
Â  Â  Â  if(p.url && shownProductUrls.has(p.url)) return;
Â  Â  Â  shownProductUrls.add(p.url);

Â  Â  Â  const a=document.createElement('a');
Â  Â  Â  a.className='product-card';
Â  Â  Â  a.href=p.url||'#';
Â  Â  Â  a.target='_blank';
Â  Â  Â  a.rel='nofollow sponsored noopener';

Â  Â  Â  const img=document.createElement('img');
Â  Â  Â  img.className='product-image';
Â  Â  Â  img.src=p.imagen||'';
Â  Â  Â  img.alt=p.nombre||'Producto';

Â  Â  Â  const details=document.createElement('div');
Â  Â  Â  details.className='product-details';

Â  Â  Â  const title=document.createElement('div');
Â  Â  Â  title.className='product-title';
Â  Â  Â  title.textContent=p.nombre||'';

Â  Â  Â  const bottom=document.createElement('div');
Â  Â  Â  bottom.className='product-info-bottom';

Â  Â  Â  const price=document.createElement('div');
Â  Â  Â  price.className='product-price';
Â  Â  Â  price.textContent=p.precio||'';

Â  Â  Â  const store=document.createElement('div');
Â  Â  Â  store.className='product-store';
Â  Â  Â  store.textContent=p.tienda ? `eBay ${p.tienda}` : 'eBay';

Â  Â  Â  bottom.appendChild(price);
Â  Â  Â  bottom.appendChild(store);
Â  Â  Â  details.appendChild(title);
Â  Â  Â  details.appendChild(bottom);

Â  Â  Â  a.appendChild(img);
Â  Â  Â  a.appendChild(details);
Â  Â  Â  container.appendChild(a);
Â  Â  });

Â  Â  chatContainer.appendChild(container);
Â  Â  scrollToBottom();
Â  }

Â  function renderResultsActions(){
Â  Â  document.getElementById('results-actions')?.remove();

Â  Â  const row=document.createElement('div');
Â  Â  row.className='results-actions';
Â  Â  row.id='results-actions';

Â  Â  const moreBtn=document.createElement('button');
Â  Â  moreBtn.className='btn';
Â  Â  moreBtn.innerText='MÃ¡s resultados';
Â  Â  moreBtn.onclick=async ()=>{
Â  Â  Â  moreBtn.disabled=true;
Â  Â  Â  await sendMessage(`${lastQueryMessage}\nMuÃ©strame mÃ¡s opciones similares.`);
Â  Â  Â  moreBtn.disabled=false;
Â  Â  };

Â  Â  const priceBtn=document.createElement('button');
Â  Â  priceBtn.className='btn secondary';
Â  Â  priceBtn.innerText='Ajustar precio';
Â  Â  priceBtn.onclick=focusPriceFilter;

Â  Â  const newBtn=document.createElement('button');
Â  Â  newBtn.className='btn secondary';
Â  Â  newBtn.innerText='Nueva bÃºsqueda';
Â  Â  newBtn.onclick=resetToLanding;

Â  Â  row.appendChild(moreBtn);
Â  Â  row.appendChild(priceBtn);
Â  Â  row.appendChild(newBtn);

Â  Â  chatContainer.appendChild(row);
Â  Â  scrollToBottom();
Â  }

Â  function focusPriceFilter(){
Â  Â  if(!document.getElementById('chips-container')){
Â  Â  Â  showRefinementChips(true);
Â  Â  }
Â  Â  const chipsContainer = document.getElementById('chips-container');
Â  Â  let priceLabel = Array.from(chipsContainer.querySelectorAll('.chips-group-label'))
Â  Â  Â  .find(el=>/precio/i.test(el.textContent||''));

Â  Â  if(!priceLabel){
Â  Â  Â  const moreBtn = Array.from(chipsContainer.querySelectorAll('button'))
Â  Â  Â  Â  .find(b=>b.textContent && b.textContent.toLowerCase().includes('mÃ¡s filtros'));
Â  Â  Â  if(moreBtn){ moreBtn.click(); }
Â  Â  Â  priceLabel = Array.from(chipsContainer.querySelectorAll('.chips-group-label'))
Â  Â  Â  Â  .find(el=>/precio/i.test(el.textContent||''));
Â  Â  }

Â  Â  if(priceLabel){
Â  Â  Â  const groupRow = priceLabel.parentElement;
Â  Â  Â  groupRow.classList.add('price-highlight');
Â  Â  Â  groupRow.scrollIntoView({behavior:'smooth', block:'center'});
Â  Â  Â  setTimeout(()=>groupRow.classList.remove('price-highlight'),1600);
Â  Â  }
Â  }

Â  function resetToLanding(){
Â  Â  activeCategory=null;
Â  Â  activeFilters={};
Â  Â  modeFallback=false;
Â  Â  moreFiltersExpanded={};
Â  Â  shownProductUrls.clear();
Â  Â  chatContainer.innerHTML = '';
Â  Â  const welcome = "<strong>Soy Tu Gregario ğŸš´â€â™‚ï¸.</strong> Busco gangas ciclistas en las mejores tiendas online por ti. Para mantener este servicio gratuito, utilizo enlaces de afiliado.<br><br><strong>Â¿QuÃ© necesitas hoy?</strong>";
Â  Â  appendMessage('bot', welcome);
Â  Â  showInitialIntentChips();
Â  Â  scrollToBottom();
Â  }

Â  function showInitialIntentChips(){
Â  Â  const chips = CONFIG.intents.map(label=>({label,value:label}));
Â  Â  const chipsElement = createCategoryChipsRow(chips);

Â  Â  const container=document.createElement('div');
Â  Â  container.className='chips-container';
Â  Â  container.id='chips-container';
Â  Â  container.appendChild(chipsElement);

Â  Â  chatContainer.appendChild(container);
Â  Â  scrollToBottom();
Â  }

Â  function createCategoryChipsRow(chips){
Â  Â  const row=document.createElement('div');
Â  Â  row.className='chips-row';
Â  Â  chips.forEach(ch=>{
Â  Â  Â  const chip=document.createElement('div');
Â  Â  Â  chip.className='chip'+(ch.label==='+'?' plus':'');
Â  Â  Â  chip.innerText=ch.label;

Â  Â  Â  chip.onclick = () => {
Â  Â  Â  Â  if(ch.label === '+'){
Â  Â  Â  Â  Â  openMoreCategories();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  handleCategorySelection(ch.label);
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  row.appendChild(chip);
Â  Â  });
Â  Â  return row;
Â  }
Â  
Â  function handleCategorySelection(categoryName) {
Â  Â  activeCategory = categoryName;
Â  Â  modeFallback = !FACETS_BY_CATEGORY[activeCategory];
Â  Â  activeFilters = {};
Â  Â  shownProductUrls.clear();
Â  Â  removeExistingChips();
Â  Â  showRefinementChips(true);
Â  }

Â  function openMoreCategories(){
Â  Â  modalContent.innerHTML='';
Â  Â  EXTRA_CATEGORIES.forEach(cat=>{
Â  Â  Â  const chip=document.createElement('div'); chip.className='chip'; chip.innerText=cat;
Â  Â  Â  chip.onclick=()=>{
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  handleCategorySelection(cat);
Â  Â  Â  };
Â  Â  Â  modalContent.appendChild(chip);
Â  Â  });

Â  Â  const other=document.createElement('div'); other.className='chip'; other.innerText='Otro productoâ€¦';
Â  Â  other.onclick=()=>{
Â  Â  Â  const val=prompt('Â¿QuÃ© producto quieres buscar? Escribe tu consulta:');
Â  Â  Â  if(val && val.trim()!==''){
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  handleCategorySelection(val.trim());
Â  Â  Â  }
Â  Â  };
Â  Â  modalContent.appendChild(other);

Â  Â  modalBackdrop.style.display='flex';
Â  }
Â  function closeModal(){ modalBackdrop.style.display='none'; }
Â  modalCloseBtn.onclick=closeModal;
Â  modalBackdrop.onclick=(e)=>{ if(e.target===modalBackdrop) closeModal(); };

Â  function getFacetGroupsWithPriceFirst(facets){
Â  Â  const entries = Object.entries(facets);
Â  Â  const idx = entries.findIndex(([k])=>/precio/i.test(k));
Â  Â  if(idx>0){ const [pair]=entries.splice(idx,1); entries.splice(2,0,pair); }
Â  Â  return entries;
Â  }

Â  function showRefinementChips(showHint=false){
Â  Â  const container=document.createElement('div');
Â  Â  container.className='chips-container'; container.id='chips-container';

Â  Â  if(showHint){
Â  Â  Â  const hint=document.createElement('div'); hint.className='chips-hint';
Â  Â  Â  hint.textContent='Selecciona tus preferencias o busca directamente ğŸ‘‡';
Â  Â  Â  container.appendChild(hint);
Â  Â  }

Â  Â  const facets = FACETS_BY_CATEGORY[activeCategory];
Â  Â  if(activeCategory && facets){
Â  Â  Â  const groups = getFacetGroupsWithPriceFirst(facets);
Â  Â  Â  const FIRST = 4;
Â  Â  Â  const first = groups.slice(0,FIRST);
Â  Â  Â  const restÂ  = groups.slice(FIRST);

Â  Â  Â  first.forEach(([group,chips])=>container.appendChild(createFacetRow(group,chips)));

Â  Â  Â  if(rest.length){
Â  Â  Â  Â  const moreBtn=document.createElement('button');
Â  Â  Â  Â  moreBtn.className='apply-filters-btn'; moreBtn.innerText='MÃ¡s filtros';
Â  Â  Â  Â  moreBtn.onclick=()=>{
Â  Â  Â  Â  Â  rest.forEach(([group,chips])=>container.appendChild(createFacetRow(group,chips)));
Â  Â  Â  Â  Â  moreBtn.remove(); moreFiltersExpanded[activeCategory]=true; scrollToBottom();
Â  Â  Â  Â  };
Â  Â  Â  Â  if(moreFiltersExpanded[activeCategory]) {
Â  Â  Â  Â  Â  rest.forEach(([group,chips])=>container.appendChild(createFacetRow(group,chips)));
Â  Â  Â  Â  } else container.appendChild(moreBtn);
Â  Â  Â  }
Â  Â  }else{
Â  Â  Â  modeFallback=true;
Â  Â  Â  Object.entries(GLOBAL_MIN_FILTERS).forEach(([group,chips])=>container.appendChild(createFacetRow(group,chips)));
Â  Â  }

Â  Â  const actionsRow=document.createElement('div'); actionsRow.className='chips-row';
Â  Â  actionsRow.style.justifyContent='space-between'; actionsRow.style.alignItems='center';
Â  Â  actionsRow.style.gap='0.5rem';

Â  Â  const clearBtn=document.createElement('button'); clearBtn.className='clear-filters-btn'; clearBtn.innerText='Limpiar';
Â  Â  clearBtn.onclick=()=>{
Â  Â  Â  activeFilters={};
Â  Â  Â  container.querySelectorAll('.chip.selected').forEach(c=>c.classList.remove('selected'));
Â  Â  Â  updateApplyButton();
Â  Â  };

Â  Â  const applyBtn=document.createElement('button');
Â  Â  applyBtn.id='apply-filters-btn'; applyBtn.className='apply-filters-btn';
Â  Â  
Â  Â  actionsRow.appendChild(clearBtn);
Â  Â  actionsRow.appendChild(applyBtn);
Â  Â  container.appendChild(actionsRow);

Â  Â  chatContainer.appendChild(container);
Â  Â  updateApplyButton();
Â  Â  scrollToBottom();
Â  }

Â  function createFacetRow(label,chipsArr){
Â  Â  const row=document.createElement('div'); row.className='chips-row';
Â  Â  const labelEl=document.createElement('span'); labelEl.className='chips-group-label'; labelEl.innerText=label;
Â  Â  row.appendChild(labelEl);
Â  Â  chipsArr.forEach(lbl=>{
Â  Â  Â  const chip=document.createElement('div'); chip.className='chip'; chip.innerText=lbl;
Â  Â  Â  chip.onclick=()=>handleRefinementClick(chip,{group:label,value:lbl});
Â  Â  Â  row.appendChild(chip);
Â  Â  });
Â  Â  return row;
Â  }

Â  function handleRefinementClick(chipEl, chipData){
Â  Â  chipEl.classList.toggle('selected');
Â  Â  if(chipEl.classList.contains('selected')) activeFilters[chipData.group]=chipData.value;
Â  Â  else delete activeFilters[chipData.group];
Â  Â  updateApplyButton();
Â  }

Â  function updateApplyButton(){
Â  Â  const btn = document.getElementById('apply-filters-btn');
Â  Â  if (!btn) return;
Â  Â  
Â  Â  const count = Object.keys(activeFilters).length;
Â  Â  if (count > 0) {
Â  Â  Â  btn.innerText = `âœ¨ Aplicar y Buscar (${count})`;
Â  Â  Â  btn.onclick = applyFilters;
Â  Â  } else {
Â  Â  Â  btn.innerText = 'ğŸ” Buscar sin filtros';
Â  Â  Â  btn.onclick = applyFilters; // Llama a la misma funciÃ³n, que ya sabe construir la query
Â  Â  }
Â  }

Â  function applyFilters(){
Â  Â  const base = `Busco ${activeCategory}`;
Â  Â  const parts=[];
Â  Â  for(const [k,v] of Object.entries(activeFilters)){
Â  Â  Â  const key=k.toLowerCase();
Â  Â  Â  if(key.includes('talla') && !key.includes('eu')) parts.push(`en talla ${v}`);
Â  Â  Â  else if(key.includes('talla eu')) parts.push(`talla EU ${v}`);
Â  Â  Â  else if(key.includes('precio')){
Â  Â  Â  Â  if(v.startsWith('<')) parts.push(`por menos de ${v.replace('<','')}`);
Â  Â  Â  Â  else if(v.startsWith('+')) parts.push(`por mÃ¡s de ${v.replace('+','')}`);
Â  Â  Â  Â  else if(/â€“|-/.test(v)){ const [a,b]=v.replace('â‚¬','').split(/â€“|-/); parts.push(`con presupuesto entre ${a.trim()} y ${b.trim()} â‚¬`); }
Â  Â  Â  Â  else parts.push(`con presupuesto ${v}`);
Â  Â  Â  }
Â  Â  Â  else if(key.includes('disciplina')) parts.push(`para ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='seguridad') parts.push(`con ${v}`);
Â  Â  Â  else if(key==='peso') parts.push(`peso ${v}`);
Â  Â  Â  else if(key==='cala') parts.push(`para calas ${v}`);
Â  Â  Â  else if(key==='rigidez') parts.push(`rigidez ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='ventilaciÃ³n' || key==='ventilacion') parts.push(`ventilaciÃ³n ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='navegaciÃ³n' || key==='navegacion') parts.push(v==='Mapas'?'con mapas':'para seguimiento bÃ¡sico');
Â  Â  Â  else if(key==='conectividad') parts.push(`conectividad ${v}`);
Â  Â  Â  else if(key==='mÃ©tricas' || key==='metricas') parts.push(`mÃ©tricas ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='tipo') parts.push(`de tipo ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='apps') parts.push(`compatible con ${v}`);
Â  Â  Â  else if(key==='potencia' || key==='simulaciÃ³n' || key==='simulacion') parts.push(`${key} ${v}`);
Â  Â  Â  else if(key==='compatibilidad') parts.push(`compatibles con ${v}`);
Â  Â  Â  else if(key==='mediciÃ³n' || key==='medicion') parts.push(`mediciÃ³n ${v}`);
Â  Â  Â  else if(key==='longitud biela') parts.push(`biela ${v} mm`);
Â  Â  Â  else if(key==='precisiÃ³n' || key==='precision') parts.push(`precisiÃ³n ${v}`);
Â  Â  Â  else if(key==='tamaÃ±o' || key==='tamano') parts.push(`${v}`);
Â  Â  Â  else if(key==='freno') parts.push(`freno de ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='material') parts.push(v.toLowerCase());
Â  Â  Â  else if(key==='tubeless') parts.push(`tubeless ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='lÃºmenes' || key==='lumenes') parts.push(`${v} lÃºmenes`);
Â  Â  Â  else if(key==='autonomÃ­a' || key==='autonomia') parts.push(`autonomÃ­a ${v}`);
Â  Â  Â  else if(key==='montaje') parts.push(`montaje en ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='estaciÃ³n' || key==='estacion') parts.push(`de ${v.toLowerCase()}`);
Â  Â  Â  else if(key==='membrana') parts.push(`membrana ${v}`);
Â  Â  Â  else if(key==='carbohora') parts.push(`${v} de carbo/h`);
Â  Â  Â  else if(key==='cafeÃ­na' || key==='cafeina') parts.push(`con cafeÃ­na`);
Â  Â  Â  else if(key==='badana') parts.push(`badana ${v}`);
Â  Â  Â  else parts.push(`${k} ${v}`);
Â  Â  }
Â  Â  const msg = parts.length ? `${base} ${parts.join(', ')}.` : base;
Â  Â  sendMessage(msg);
Â  }
Â  
Â  function detectActiveCategoryFromMessage(message){
Â  Â  const m=message.trim().toLowerCase();
Â  Â  if(m.startsWith('busco')){
Â  Â  Â  const cat = Object.keys(FACETS_BY_CATEGORY).find(k=>m.includes(k.toLowerCase()));
Â  Â  Â  activeCategory = cat || activeCategory;
Â  Â  Â  modeFallback = !FACETS_BY_CATEGORY[activeCategory];
Â  Â  Â  if(!cat && m.startsWith('busco ')){ activeCategory = m.replace(/^busco\s+/,'').trim(); modeFallback = true; }
Â  Â  }
Â  }

Â  // Helpers
Â  function showLoadingSkeletons(){
Â  Â  const container=document.createElement('div'); container.className='ge-skeletons'; container.id='loading-skeletons';
Â  Â  for(let i=0;i<6;i++){ const sk=document.createElement('div'); sk.className='ge-skel'; container.appendChild(sk); }
Â  Â  chatContainer.appendChild(container); scrollToBottom();
Â  }
Â  function removeLoadingSkeletons(){ document.getElementById('loading-skeletons')?.remove(); }
Â  function removeExistingChips(){ document.getElementById('chips-container')?.remove(); }
Â  function scrollToBottom(){ chatContainer.scrollTop = chatContainer.scrollHeight; }
Â  function setLoading(b){ sendButton.disabled=b; userInput.disabled=b; }

Â  // Init
Â  sendButton.addEventListener('click',()=>sendMessage(null));
Â  userInput.addEventListener('keypress',(e)=>{ if(e.key==='Enter' && !e.shiftKey) sendMessage(null); });

Â  document.addEventListener('DOMContentLoaded',()=>{
Â  Â  const welcome = "<strong>Soy Tu Gregario ğŸš´â€â™‚ï¸.</strong> Busco gangas ciclistas en las mejores tiendas online por ti. Para mantener este servicio gratuito, utilizo enlaces de afiliado.<br><br><strong>Â¿QuÃ© necesitas hoy?</strong>";
Â  Â  appendMessage('bot', welcome);
Â  Â  showInitialIntentChips();
Â  Â  userInput.focus();
Â  });
</script>

</body>
</html>
