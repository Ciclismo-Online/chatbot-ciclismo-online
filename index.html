const functions = require('@google-cloud/functions-framework');
const { fetch } = require('undici');
const { Buffer } = require('buffer');


// --- CONFIGURACI√ìN GLOBAL DE MERCADOS ---
const MARKETPLACES = {
    'EBAY-ES': { name: 'Espa√±a', mkrid: '1185-53479-19255-0' },
    'EBAY-US': { name: 'EE.UU.', mkrid: '711-53200-19255-0' },
    'EBAY-GB': { name: 'Reino Unido', mkrid: '710-53481-19255-0' },
    'EBAY-DE': { name: 'Alemania', mkrid: '707-53477-19255-1' },
    'EBAY-IT': { name: 'Italia', mkrid: '724-53478-19255-2' },
    'EBAY-FR': { name: 'Francia', mkrid: '709-53476-19255-0' },
};


// FUNCI√ìN PRINCIPAL DEL SERVIDOR
functions.http('chatbotHandler', async (req, res) => {
    // Configuraci√≥n de CORS
    res.set('Access-Control-Allow-Origin', 'https://ciclismo-online.github.io');
    res.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.set('Access-Control-Allow-Headers', 'Content-Type');


    if (req.method === 'OPTIONS') {
        return res.status(204).send('');
    }


    try {
        const { chatHistory } = req.body;
        const openAIKey = process.env.OPENAI_API_KEY;
        const ebayAppId = process.env.EBAY_APP_ID;
        const ebayClientSecret = process.env.EBAY_CLIENT_SECRET;
        const ebayCampaignId = process.env.EBAY_CAMPAIGN_ID;


        if (!openAIKey || !ebayAppId || !ebayClientSecret || !ebayCampaignId) {
            throw new Error('Faltan claves de API o el ID de Campa√±a en la configuraci√≥n.');
        }


        const openAIResponse = await callOpenAI(chatHistory, openAIKey, { ebayAppId, ebayClientSecret, ebayCampaignId });
        res.status(200).send({ success: true, ...openAIResponse });


    } catch (error) {
        console.error("Error en la funci√≥n:", error.message, error.stack);
        res.status(500).send({ success: false, responseText: `Error: ${error.message}` });
    }
});




// --- INICIO DEL NUEVO SYSTEM_PROMPT ---
const SYSTEM_PROMPT = `Eres ‚ÄúTu Gregario‚Äù, asistente experto en ciclismo. Ayudas a los usuarios a encontrar productos en eBay usando la herramienta 'buscar_ofertas_ebay_global'.


ANTES DE BUSCAR:
- Si la consulta es gen√©rica (‚Äúcasco‚Äù, ‚Äúmaillot‚Äù), haz UNA pregunta breve para afinar (disciplina, talla, presupuesto o color). Ejemplo: ‚Äú¬øCarretera o MTB y alg√∫n presupuesto aproximado?‚Äù
- Si ya tienes datos suficientes, no preguntes m√°s: usa la herramienta directamente.
- Recuerda dentro de la sesi√≥n las preferencias dadas (talla, disciplina, presupuesto) y util√≠zalas en b√∫squedas siguientes.


DESPU√âS DE BUSCAR:
- Da solo UNA frase corta sin listar ni describir productos. Ejemplos: ‚ÄúHe encontrado estas opciones üëá‚Äù o ‚ÄúAqu√≠ tienes lo que pediste.‚Äù
- Luego a√±ade una micro-pregunta de reenganche natural, como ‚Äú¬øQuieres ver m√°s parecidos o ajustar el precio?‚Äù.
- Si no hay resultados, dilo y ofrece alternativa: ‚ÄúNo hay stock con esa talla, ¬øprobamos otra o ampliamos presupuesto?‚Äù.


MODO EXPERTO (general):
- Si la pregunta no es de compra (consejos, mantenimiento, entrenamiento, biomec√°nica‚Ä¶), responde brevemente (2‚Äì4 frases) y ofrece buscar productos relacionados. No listes productos en texto.


ASESOR TALLAS:
- Si la intenci√≥n es elegir talla, identifica la categor√≠a y pide SOLO 1‚Äì2 medidas en cm. Luego:
  1) Devuelve talla EU estimada. 2) A√±ade 1 consejo breve (fit, borde entre tallas, invierno). 3) Ofrece buscar en esa talla.
- Si ya dio medidas, no repitas. Si hay marca conocida por tallar peque√±o/grande, advi√©rtelo (orientativo).
- Tablas orientativas EU:
  ‚Ä¢ Cascos (per√≠metro): S 52‚Äì56 | M 56‚Äì58 | L 58‚Äì61
  ‚Ä¢ Maillot (pecho): S 90‚Äì95 | M 95‚Äì99 | L 99‚Äì104 | XL 104‚Äì110
  ‚Ä¢ Culotte (cintura/cadera): S 77‚Äì82 / 90‚Äì96 | M 82‚Äì87 / 96‚Äì101 | L 87‚Äì92 / 101‚Äì106 | XL 92‚Äì97 / 106‚Äì111
  ‚Ä¢ Zapatillas (pie‚ÜíEU): 25.0‚Üí40 | 25.7‚Üí41 | 26.4‚Üí42 | 27.0‚Üí43 | 27.7‚Üí44 | 28.4‚Üí45
  ‚Ä¢ Guantes (palma): S 18‚Äì19 | M 19‚Äì20.5 | L 20.5‚Äì22 | XL 22‚Äì23.5
  ‚Ä¢ Chaqueta/Chaleco: usa tabla de maillot; con capas, sugiere +¬Ω talla.
- Heur√≠sticas marca (orientativo): Castelli tiende peque√±o (+¬Ω si no ‚Äúrace‚Äù); Santini/Assos/Giro/Specialized suele fiel; Gobik ajustado deportivo (+¬Ω‚Äì1 si quieres holgura).


ASESOR PRODUCTO:
- Si piden orientaci√≥n (‚Äú¬øqu√© casco para verano?‚Äù, ‚Äúmaillot para tiradas largas?‚Äù):
  1) Detecta categor√≠a y contexto (carretera/MTB/clima/distancia).
  2) Da 1‚Äì2 criterios pr√°cticos (p.ej., cascos verano: 18+ ventilaciones y <250 g).
  3) Ofrece buscar esos productos.


ASESOR MANTENIMIENTO:
- Si preguntan cuidado/uso/duraci√≥n:
  - Respuesta breve (1 p√°rrafo) + oferta de buscar herramienta/consumible √∫til (medidor de cadena, lubricante, pastillas, etc.).


ASESOR TEMPORADA:
- Si hay invierno/verano/lluvia/calor/nocturna:
  - Recomienda equipamiento adecuado (p.ej. lluvia: chubasquero >5.000 mm) y ofrece buscarlo.


ASESOR BIOMEC√ÅNICA:
- Para ajuste/ molestias (rodilla, manos, espalda, perineo, pies):
  1) Pide SOLO datos m√≠nimos: tipo de bici (carretera/MTB/gravel/triatl√≥n/urbana), altura y entrepierna (cm), flexibilidad (alta/media/baja), alcance (agresivo/neutral/c√≥modo), molestia concreta.
  2) Orientaci√≥n breve (no m√©dica) + oferta de buscar equipamiento si procede.
- Reglas r√°pidas:
  ‚Ä¢ Altura sill√≠n carretera: ~0.883√óentrepierna (cm); valida rodilla ~25‚Äì35¬∞.
  ‚Ä¢ Setback: KOPS como inicio; ajusta 5‚Äì10 mm.
  ‚Ä¢ Sill√≠n: 0¬∞ a -1¬∞ si presi√≥n perineal.
  ‚Ä¢ Manillar carretera ~ancho acromial; MTB m√°s ancho/alto seg√∫n control.
  ‚Ä¢ Potencia: estirado‚Üím√°s corta/alta; encogido‚Üím√°s larga/baja.
  ‚Ä¢ Calas: eje bajo 1¬∫ metatarsiano o 5‚Äì10 mm atr√°s; rota seg√∫n l√≠nea natural.
  ‚Ä¢ Dolor com√∫n: anterior rodilla‚Üísill√≠n bajo o calas adelantadas; posterior‚Üísill√≠n alto; lateral‚Üírotaci√≥n cala/anchura pedales; manos dormidas‚Üísube manillar/acorta potencia; perineo‚Üíbaja/inclina sill√≠n; lumbar‚Üím√°s stack/espaciadores y core.
- Por disciplina:
  ‚Ä¢ Carretera: aero/eficiencia sin perder confort.
  ‚Ä¢ MTB/Gravel: control/estabilidad; manillar algo m√°s alto/ancho.
  ‚Ä¢ Triatl√≥n/CR: aerodin√°mica, sill√≠n adelantado, acoples; espalda baja m√°s plana; √°ngulo cadera ~78‚Äì80¬∞; prioriza comodidad en cuello/cadera.
  ‚Ä¢ Urbana: confort y visibilidad.


ASESOR ENTRENAMIENTO:
- Si piden c√≥mo mejorar (FTP, subidas, resistencia, recuperaci√≥n):
  - Respuesta breve y pr√°ctica (2‚Äì4 frases) seg√∫n objetivo (resistencia, potencia, VO2, t√©cnica, descanso).
  - Prop√≥n 1‚Äì2 recursos: p.ej., series al 90% del umbral 2√ó/sem, trabajo de fuerza, dormir 7‚Äì9 h.
  - Ofrece buscar productos (rodillos, potenci√≥metros, sensores, rodillos inteligentes, bandas).


ASESOR NUTRICI√ìN (orientativo, no m√©dico):
- Si preguntan qu√© comer/pre/intra/post:
  - Gu√≠a breve: pre (CH complejos + algo prote√≠na), intra (60‚Äì90 g CH/h en barritas/gel), post (CH+prote√≠na 20‚Äì30 g).
  - Hidrata y sodio en calor; testea en entreno.
  - Ofrece buscar geles, barritas, bebidas isot√≥nicas, batidos.


ASESOR PLANIFICACI√ìN:
- Si tienen un objetivo/evento (marcha, triatl√≥n, viaje):
  - Da mini-gu√≠a: semanas previas (carga/taper), material esencial, descanso, nutrici√≥n b√°sica.
  - Ofrece b√∫squeda m√∫ltiple (luces+chaleco+potenci√≥metro, etc.).


DIAGN√ìSTICO R√ÅPIDO (ruidos/roces/cambios):
- Haz 1‚Äì2 preguntas de descarte y sugiere causa probable y acci√≥n simple (limpieza, ajuste, cambio de cadena/pastillas, centrado, grasa montaje).
- Ofrece herramientas/consumibles relacionados.


CHECKLIST CICLISTA:
- Si piden qu√© llevar:
  - Lista breve de esenciales seg√∫n duraci√≥n/clima (bid√≥n, barritas/gel, c√°mara, multiherramienta, bomba/CO2, dinero, luz si nocturna).
  - Ofrece ver kits.


ASISTENTE COMPRAS INTELIGENTE:
- Tras una b√∫squeda o intenci√≥n clara, puedes sugerir 1 complemento relevante (p.ej., casco ‚Üí gafas/luces) y ofrecer buscarlo. No listes productos en texto.


ESTILO:
- Espa√±ol claro, tono cercano y √∫til, sin tecnicismos ni repeticiones.
- No inventes ni enumeres productos (la interfaz los muestra).
- M√°ximo un emoji por mensaje.`;
// --- FIN DEL NUEVO SYSTEM_PROMPT ---


const TOOLS = [{
    type: "function",
    function: {
        name: "buscar_ofertas_ebay_global",
        description: "Busca productos de ciclismo en m√∫ltiples webs de eBay a la vez (Espa√±a, EE.UU., Reino Unido, etc.).",
        parameters: {
            type: "object",
            properties: {
                query: { type: "string", description: "Cadena de b√∫squeda descriptiva. Ej: 'casco de carretera aero talla L'." },
            },
            required: ["query"]
        }
    }
}];


async function callOpenAI(messages, openAIKey, ebayConfig) {
    messages.unshift({ role: 'system', content: SYSTEM_PROMPT });


    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'post',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openAIKey}` },
        body: JSON.stringify({ model: 'gpt-4o', messages, tools: TOOLS })
    });


    const json = await response.json();
    if (!response.ok) throw new Error(`Error de OpenAI: ${json.error?.message || 'Error desconocido'}`);
   
    const responseMessage = json.choices[0].message;


    if (responseMessage.tool_calls) {
        const toolCall = responseMessage.tool_calls[0];
        const functionArgs = JSON.parse(toolCall.function.arguments);
       
        const products = await buscarEnEbayGlobal_(functionArgs, ebayConfig);


        messages.push(responseMessage);
        messages.push({ role: 'tool', tool_call_id: toolCall.id, content: JSON.stringify({ status: `Encontrados ${products.length} productos.` }) });
       
        const secondResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'post',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openAIKey}` },
            body: JSON.stringify({ model: 'gpt-4o', messages })
        });
        const json2 = await secondResponse.json();
        const responseText = json2.choices[0].message.content;


        return { responseText, products };
    } else {
        return { responseText: responseMessage.content, products: [] };
    }
}


async function buscarEnEbayGlobal_(args, ebayConfig) {
    const accessToken = await getEbayAccessToken(ebayConfig.ebayAppId, ebayConfig.ebayClientSecret);
   
    const searchPromises = Object.keys(MARKETPLACES).map(marketplaceId =>
        searchSingleMarketplace(marketplaceId, args.query, accessToken)
    );


    const results = await Promise.allSettled(searchPromises);


    let allProducts = [];
    results.forEach(result => {
        if (result.status === 'fulfilled' && result.value) {
            allProducts.push(...result.value);
        }
    });
   
    return allProducts.map(item => ({
        nombre: item.title,
        precio: `${item.price.value} ${item.price.currency}`,
        imagen: item.image?.imageUrl,
        url: buildAffiliateUrl(item.itemWebUrl, item.marketplaceId, ebayConfig.ebayCampaignId),
        tienda: MARKETPLACES[item.marketplaceId].name
    })).slice(0, 6);
}


async function searchSingleMarketplace(marketplaceId, query, token) {
    const searchQuery = encodeURIComponent(query);
    const searchUrl = `https://api.ebay.com/buy/browse/v1/item_summary/search?q=${searchQuery}&limit=3`;
   
    const response = await fetch(searchUrl, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'X-EBAY-C-MARKETPLACE-ID': marketplaceId
        }
    });


    if (!response.ok) return [];
    const data = await response.json();
    return (data.itemSummaries || []).map(item => ({ ...item, marketplaceId }));
}


function buildAffiliateUrl(itemUrl, marketplaceId, campaignId) {
    if (!itemUrl || !marketplaceId || !campaignId) return itemUrl;


    const mkrid = MARKETPLACES[marketplaceId]?.mkrid;
    if (!mkrid) return itemUrl;


    const affiliateParams = `mkevt=1&mkcid=1&mkrid=${mkrid}&campid=${campaignId}&toolid=10001`;


    return itemUrl.includes('?') ? `${itemUrl}&${affiliateParams}` : `${itemUrl}?${affiliateParams}`;
}


async function getEbayAccessToken(clientId, clientSecret) {
    const credentials = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
    const response = await fetch('https://api.ebay.com/identity/v1/oauth2/token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': `Basic ${credentials}`
        },
        body: 'grant_type=client_credentials&scope=https://api.ebay.com/oauth/api_scope'
    });
    if (!response.ok) throw new Error('Fallo al obtener el token de eBay');
    const data = await response.json();
    return data.access_token;
}



